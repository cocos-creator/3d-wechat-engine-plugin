System.register(["./deprecated-0768b3d4.js","./deprecated-4df5f565.js","./screen-f991c158.js","./webgl-define-f890b6ea.js"],(function(e){"use strict";var t,r,s,i,a,n,u,l,_,c,o,f,h,d,g,R,A,E,p,T,S,B,C,m,x,b,F,P,I,G,M,O,v,D,L,U,N,y,w,k,V,W,H,X,z,K,Y,q,Z,j,Q,J,$,ee,te,re,se,ie,ae,ne,ue,le,_e,ce,oe,fe;return{setters:[function(e){t=e._,r=e.a,s=e.z,i=e.q,a=e.p,n=e.aU,u=e.Q,l=e.y,_=e.w,c=e.l},function(e){o=e.c1,f=e.c2,h=e.c4,d=e.F,g=e.cQ,R=e.c5,A=e.M,E=e.b,p=e.cs,T=e.cN,S=e.cO,B=e.cu,C=e.cq,m=e.cz,x=e.cp,b=e.ck,F=e.cD,P=e.cE,I=e.cv,G=e.cf,M=e.cw,O=e.c7,v=e.cg,D=e.c9,L=e.cR,U=e.cy,N=e.cb,y=e.dg,w=e.d0,k=e.d1,V=e.d4,W=e.d5,H=e.d7,X=e.de,z=e.di,K=e.dn,Y=e.dq,q=e.dw,Z=e.d8,j=e.d9,Q=e.db,J=e.eL,$=e.cP,ee=e.dz,te=e.cI,re=e.cK,se=e.dh,ie=e.cF,ae=e.ca,ne=e.dx,ue=e.ct,le=e.cX,_e=e.eM,ce=e.cY,oe=e.c_},function(){},function(e){fe=e.W}],execute:function(){var he=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,i=t.descriptorCount;this._buffers=Array(i).fill(null),this._textures=Array(i).fill(null),this._samplers=Array(i).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],l=0;l<u.count;l++)a.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0},i.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},i.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&o?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&f&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(h),de=[10497,33648,33071,33071],ge=[1,2,4,8,16,32,64],Re=new Float32Array(4);function Ae(e,t){switch(e){case d.R8:return t.UNSIGNED_BYTE;case d.R8SN:return t.BYTE;case d.R8UI:return t.UNSIGNED_BYTE;case d.R8I:return t.BYTE;case d.R16F:return t.HALF_FLOAT;case d.R16UI:return t.UNSIGNED_SHORT;case d.R16I:return t.SHORT;case d.R32F:return t.FLOAT;case d.R32UI:return t.UNSIGNED_INT;case d.R32I:return t.INT;case d.RG8:return t.UNSIGNED_BYTE;case d.RG8SN:return t.BYTE;case d.RG8UI:return t.UNSIGNED_BYTE;case d.RG8I:return t.BYTE;case d.RG16F:return t.HALF_FLOAT;case d.RG16UI:return t.UNSIGNED_SHORT;case d.RG16I:return t.SHORT;case d.RG32F:return t.FLOAT;case d.RG32UI:return t.UNSIGNED_INT;case d.RG32I:return t.INT;case d.RGB8:case d.SRGB8:return t.UNSIGNED_BYTE;case d.RGB8SN:return t.BYTE;case d.RGB8UI:return t.UNSIGNED_BYTE;case d.RGB8I:return t.BYTE;case d.RGB16F:return t.HALF_FLOAT;case d.RGB16UI:return t.UNSIGNED_SHORT;case d.RGB16I:return t.SHORT;case d.RGB32F:return t.FLOAT;case d.RGB32UI:return t.UNSIGNED_INT;case d.RGB32I:return t.INT;case d.BGRA8:case d.RGBA8:case d.SRGB8_A8:return t.UNSIGNED_BYTE;case d.RGBA8SN:return t.BYTE;case d.RGBA8UI:return t.UNSIGNED_BYTE;case d.RGBA8I:return t.BYTE;case d.RGBA16F:return t.HALF_FLOAT;case d.RGBA16UI:return t.UNSIGNED_SHORT;case d.RGBA16I:return t.SHORT;case d.RGBA32F:return t.FLOAT;case d.RGBA32UI:return t.UNSIGNED_INT;case d.RGBA32I:return t.INT;case d.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case d.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case d.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case d.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case d.RGB10A2:case d.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case d.RGB9E5:return t.FLOAT;case d.D16:return t.UNSIGNED_SHORT;case d.D16S8:return t.UNSIGNED_INT_24_8;case d.D24:return t.UNSIGNED_INT;case d.D24S8:return t.UNSIGNED_INT_24_8;case d.D32F:return t.FLOAT;case d.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case d.BC1:case d.BC1_SRGB:case d.BC2:case d.BC2_SRGB:case d.BC3:case d.BC3_SRGB:case d.BC4:return t.UNSIGNED_BYTE;case d.BC4_SNORM:return t.BYTE;case d.BC5:return t.UNSIGNED_BYTE;case d.BC5_SNORM:return t.BYTE;case d.BC6H_SF16:case d.BC6H_UF16:return t.FLOAT;case d.BC7:case d.BC7_SRGB:case d.ETC_RGB8:case d.ETC2_RGB8:case d.ETC2_SRGB8:case d.ETC2_RGB8_A1:case d.ETC2_SRGB8_A1:case d.EAC_R11:return t.UNSIGNED_BYTE;case d.EAC_R11SN:return t.BYTE;case d.EAC_RG11:return t.UNSIGNED_BYTE;case d.EAC_RG11SN:return t.BYTE;case d.PVRTC_RGB2:case d.PVRTC_RGBA2:case d.PVRTC_RGB4:case d.PVRTC_RGBA4:case d.PVRTC2_2BPP:case d.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case d.ASTC_RGBA_4x4:case d.ASTC_RGBA_5x4:case d.ASTC_RGBA_5x5:case d.ASTC_RGBA_6x5:case d.ASTC_RGBA_6x6:case d.ASTC_RGBA_8x5:case d.ASTC_RGBA_8x6:case d.ASTC_RGBA_8x8:case d.ASTC_RGBA_10x5:case d.ASTC_RGBA_10x6:case d.ASTC_RGBA_10x8:case d.ASTC_RGBA_10x10:case d.ASTC_RGBA_12x10:case d.ASTC_RGBA_12x12:case d.ASTC_SRGBA_4x4:case d.ASTC_SRGBA_5x4:case d.ASTC_SRGBA_5x5:case d.ASTC_SRGBA_6x5:case d.ASTC_SRGBA_6x6:case d.ASTC_SRGBA_8x5:case d.ASTC_SRGBA_8x6:case d.ASTC_SRGBA_8x8:case d.ASTC_SRGBA_10x5:case d.ASTC_SRGBA_10x6:case d.ASTC_SRGBA_10x8:case d.ASTC_SRGBA_10x10:case d.ASTC_SRGBA_12x10:case d.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function Ee(e,t){switch(e){case d.A8:return t.ALPHA;case d.L8:return t.LUMINANCE;case d.LA8:return t.LUMINANCE_ALPHA;case d.R8:return t.R8;case d.R8SN:return t.R8_SNORM;case d.R8UI:return t.R8UI;case d.R8I:return t.R8I;case d.RG8:return t.RG8;case d.RG8SN:return t.RG8_SNORM;case d.RG8UI:return t.RG8UI;case d.RG8I:return t.RG8I;case d.RGB8:return t.RGB8;case d.RGB8SN:return t.RGB8_SNORM;case d.RGB8UI:return t.RGB8UI;case d.RGB8I:return t.RGB8I;case d.BGRA8:case d.RGBA8:return t.RGBA8;case d.RGBA8SN:return t.RGBA8_SNORM;case d.RGBA8UI:return t.RGBA8UI;case d.RGBA8I:return t.RGBA8I;case d.R16I:return t.R16I;case d.R16UI:return t.R16UI;case d.R16F:return t.R16F;case d.RG16I:return t.RG16I;case d.RG16UI:return t.RG16UI;case d.RG16F:return t.RG16F;case d.RGB16I:return t.RGB16I;case d.RGB16UI:return t.RGB16UI;case d.RGB16F:return t.RGB16F;case d.RGBA16I:return t.RGBA16I;case d.RGBA16UI:return t.RGBA16UI;case d.RGBA16F:return t.RGBA16F;case d.R32I:return t.R32I;case d.R32UI:return t.R32UI;case d.R32F:return t.R32F;case d.RG32I:return t.RG32I;case d.RG32UI:return t.RG32UI;case d.RG32F:return t.RG32F;case d.RGB32I:return t.RGB32I;case d.RGB32UI:return t.RGB32UI;case d.RGB32F:return t.RGB32F;case d.RGBA32I:return t.RGBA32I;case d.RGBA32UI:return t.RGBA32UI;case d.RGBA32F:return t.RGBA32F;case d.R5G6B5:return t.RGB565;case d.RGB5A1:return t.RGB5_A1;case d.RGBA4:return t.RGBA4;case d.RGB10A2:return t.RGB10_A2;case d.RGB10A2UI:return t.RGB10_A2UI;case d.R11G11B10F:return t.R11F_G11F_B10F;case d.D16:return t.DEPTH_COMPONENT16;case d.D16S8:return t.DEPTH24_STENCIL8;case d.D24:return t.DEPTH_COMPONENT24;case d.D24S8:return t.DEPTH24_STENCIL8;case d.D32F:return t.DEPTH_COMPONENT32F;case d.D32F_S8:return t.DEPTH32F_STENCIL8;case d.BC1:return fe.COMPRESSED_RGB_S3TC_DXT1_EXT;case d.BC1_ALPHA:return fe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case d.BC1_SRGB:return fe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case d.BC1_SRGB_ALPHA:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case d.BC2:return fe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case d.BC2_SRGB:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case d.BC3:return fe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case d.BC3_SRGB:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case d.ETC_RGB8:return fe.COMPRESSED_RGB_ETC1_WEBGL;case d.ETC2_RGB8:return fe.COMPRESSED_RGB8_ETC2;case d.ETC2_SRGB8:return fe.COMPRESSED_SRGB8_ETC2;case d.ETC2_RGB8_A1:return fe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case d.ETC2_SRGB8_A1:return fe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case d.ETC2_RGBA8:return fe.COMPRESSED_RGBA8_ETC2_EAC;case d.ETC2_SRGB8_A8:return fe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case d.EAC_R11:return fe.COMPRESSED_R11_EAC;case d.EAC_R11SN:return fe.COMPRESSED_SIGNED_R11_EAC;case d.EAC_RG11:return fe.COMPRESSED_RG11_EAC;case d.EAC_RG11SN:return fe.COMPRESSED_SIGNED_RG11_EAC;case d.PVRTC_RGB2:return fe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case d.PVRTC_RGBA2:return fe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case d.PVRTC_RGB4:return fe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case d.PVRTC_RGBA4:return fe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case d.ASTC_RGBA_4x4:return fe.COMPRESSED_RGBA_ASTC_4x4_KHR;case d.ASTC_RGBA_5x4:return fe.COMPRESSED_RGBA_ASTC_5x4_KHR;case d.ASTC_RGBA_5x5:return fe.COMPRESSED_RGBA_ASTC_5x5_KHR;case d.ASTC_RGBA_6x5:return fe.COMPRESSED_RGBA_ASTC_6x5_KHR;case d.ASTC_RGBA_6x6:return fe.COMPRESSED_RGBA_ASTC_6x6_KHR;case d.ASTC_RGBA_8x5:return fe.COMPRESSED_RGBA_ASTC_8x5_KHR;case d.ASTC_RGBA_8x6:return fe.COMPRESSED_RGBA_ASTC_8x6_KHR;case d.ASTC_RGBA_8x8:return fe.COMPRESSED_RGBA_ASTC_8x8_KHR;case d.ASTC_RGBA_10x5:return fe.COMPRESSED_RGBA_ASTC_10x5_KHR;case d.ASTC_RGBA_10x6:return fe.COMPRESSED_RGBA_ASTC_10x6_KHR;case d.ASTC_RGBA_10x8:return fe.COMPRESSED_RGBA_ASTC_10x8_KHR;case d.ASTC_RGBA_10x10:return fe.COMPRESSED_RGBA_ASTC_10x10_KHR;case d.ASTC_RGBA_12x10:return fe.COMPRESSED_RGBA_ASTC_12x10_KHR;case d.ASTC_RGBA_12x12:return fe.COMPRESSED_RGBA_ASTC_12x12_KHR;case d.ASTC_SRGBA_4x4:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case d.ASTC_SRGBA_5x4:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case d.ASTC_SRGBA_5x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case d.ASTC_SRGBA_6x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case d.ASTC_SRGBA_6x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case d.ASTC_SRGBA_8x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case d.ASTC_SRGBA_8x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case d.ASTC_SRGBA_8x8:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case d.ASTC_SRGBA_10x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case d.ASTC_SRGBA_10x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case d.ASTC_SRGBA_10x8:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case d.ASTC_SRGBA_10x10:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case d.ASTC_SRGBA_12x10:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case d.ASTC_SRGBA_12x12:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}function pe(e,t){switch(e){case d.A8:return t.ALPHA;case d.L8:return t.LUMINANCE;case d.LA8:return t.LUMINANCE_ALPHA;case d.R8:case d.R8SN:return t.RED;case d.R8UI:case d.R8I:return t.RED;case d.RG8:case d.RG8SN:case d.RG8UI:case d.RG8I:return t.RG;case d.RGB8:case d.RGB8SN:case d.RGB8UI:case d.RGB8I:return t.RGB;case d.BGRA8:case d.RGBA8:case d.RGBA8SN:case d.RGBA8UI:case d.RGBA8I:return t.RGBA;case d.R16UI:case d.R16I:case d.R16F:return t.RED;case d.RG16UI:case d.RG16I:case d.RG16F:return t.RG;case d.RGB16UI:case d.RGB16I:case d.RGB16F:return t.RGB;case d.RGBA16UI:case d.RGBA16I:case d.RGBA16F:return t.RGBA;case d.R32UI:case d.R32I:case d.R32F:return t.RED;case d.RG32UI:case d.RG32I:case d.RG32F:return t.RG;case d.RGB32UI:case d.RGB32I:case d.RGB32F:return t.RGB;case d.RGBA32UI:case d.RGBA32I:case d.RGBA32F:case d.RGB10A2:return t.RGBA;case d.R11G11B10F:case d.R5G6B5:return t.RGB;case d.RGB5A1:case d.RGBA4:return t.RGBA;case d.D16:return t.DEPTH_COMPONENT;case d.D16S8:return t.DEPTH_STENCIL;case d.D24:return t.DEPTH_COMPONENT;case d.D24S8:return t.DEPTH_STENCIL;case d.D32F:return t.DEPTH_COMPONENT;case d.D32F_S8:return t.DEPTH_STENCIL;case d.BC1:return fe.COMPRESSED_RGB_S3TC_DXT1_EXT;case d.BC1_ALPHA:return fe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case d.BC1_SRGB:return fe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case d.BC1_SRGB_ALPHA:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case d.BC2:return fe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case d.BC2_SRGB:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case d.BC3:return fe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case d.BC3_SRGB:return fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case d.ETC_RGB8:return fe.COMPRESSED_RGB_ETC1_WEBGL;case d.ETC2_RGB8:return fe.COMPRESSED_RGB8_ETC2;case d.ETC2_SRGB8:return fe.COMPRESSED_SRGB8_ETC2;case d.ETC2_RGB8_A1:return fe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case d.ETC2_SRGB8_A1:return fe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case d.ETC2_RGBA8:return fe.COMPRESSED_RGBA8_ETC2_EAC;case d.ETC2_SRGB8_A8:return fe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case d.EAC_R11:return fe.COMPRESSED_R11_EAC;case d.EAC_R11SN:return fe.COMPRESSED_SIGNED_R11_EAC;case d.EAC_RG11:return fe.COMPRESSED_RG11_EAC;case d.EAC_RG11SN:return fe.COMPRESSED_SIGNED_RG11_EAC;case d.PVRTC_RGB2:return fe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case d.PVRTC_RGBA2:return fe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case d.PVRTC_RGB4:return fe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case d.PVRTC_RGBA4:return fe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case d.ASTC_RGBA_4x4:return fe.COMPRESSED_RGBA_ASTC_4x4_KHR;case d.ASTC_RGBA_5x4:return fe.COMPRESSED_RGBA_ASTC_5x4_KHR;case d.ASTC_RGBA_5x5:return fe.COMPRESSED_RGBA_ASTC_5x5_KHR;case d.ASTC_RGBA_6x5:return fe.COMPRESSED_RGBA_ASTC_6x5_KHR;case d.ASTC_RGBA_6x6:return fe.COMPRESSED_RGBA_ASTC_6x6_KHR;case d.ASTC_RGBA_8x5:return fe.COMPRESSED_RGBA_ASTC_8x5_KHR;case d.ASTC_RGBA_8x6:return fe.COMPRESSED_RGBA_ASTC_8x6_KHR;case d.ASTC_RGBA_8x8:return fe.COMPRESSED_RGBA_ASTC_8x8_KHR;case d.ASTC_RGBA_10x5:return fe.COMPRESSED_RGBA_ASTC_10x5_KHR;case d.ASTC_RGBA_10x6:return fe.COMPRESSED_RGBA_ASTC_10x6_KHR;case d.ASTC_RGBA_10x8:return fe.COMPRESSED_RGBA_ASTC_10x8_KHR;case d.ASTC_RGBA_10x10:return fe.COMPRESSED_RGBA_ASTC_10x10_KHR;case d.ASTC_RGBA_12x10:return fe.COMPRESSED_RGBA_ASTC_12x10_KHR;case d.ASTC_RGBA_12x12:return fe.COMPRESSED_RGBA_ASTC_12x12_KHR;case d.ASTC_SRGBA_4x4:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case d.ASTC_SRGBA_5x4:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case d.ASTC_SRGBA_5x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case d.ASTC_SRGBA_6x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case d.ASTC_SRGBA_6x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case d.ASTC_SRGBA_8x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case d.ASTC_SRGBA_8x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case d.ASTC_SRGBA_8x8:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case d.ASTC_SRGBA_10x5:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case d.ASTC_SRGBA_10x6:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case d.ASTC_SRGBA_10x8:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case d.ASTC_SRGBA_10x10:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case d.ASTC_SRGBA_12x10:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case d.ASTC_SRGBA_12x12:return fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function Te(e,t){switch(e){case G.BOOL:return t.BOOL;case G.BOOL2:return t.BOOL_VEC2;case G.BOOL3:return t.BOOL_VEC3;case G.BOOL4:return t.BOOL_VEC4;case G.INT:return t.INT;case G.INT2:return t.INT_VEC2;case G.INT3:return t.INT_VEC3;case G.INT4:return t.INT_VEC4;case G.UINT:return t.UNSIGNED_INT;case G.FLOAT:return t.FLOAT;case G.FLOAT2:return t.FLOAT_VEC2;case G.FLOAT3:return t.FLOAT_VEC3;case G.FLOAT4:return t.FLOAT_VEC4;case G.MAT2:return t.FLOAT_MAT2;case G.MAT2X3:return t.FLOAT_MAT2x3;case G.MAT2X4:return t.FLOAT_MAT2x4;case G.MAT3X2:return t.FLOAT_MAT3x2;case G.MAT3:return t.FLOAT_MAT3;case G.MAT3X4:return t.FLOAT_MAT3x4;case G.MAT4X2:return t.FLOAT_MAT4x2;case G.MAT4X3:return t.FLOAT_MAT4x3;case G.MAT4:return t.FLOAT_MAT4;case G.SAMPLER2D:return t.SAMPLER_2D;case G.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case G.SAMPLER3D:return t.SAMPLER_3D;case G.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),G.UNKNOWN}}function Se(e,t){switch(e){case t.BOOL:return G.BOOL;case t.BOOL_VEC2:return G.BOOL2;case t.BOOL_VEC3:return G.BOOL3;case t.BOOL_VEC4:return G.BOOL4;case t.INT:return G.INT;case t.INT_VEC2:return G.INT2;case t.INT_VEC3:return G.INT3;case t.INT_VEC4:return G.INT4;case t.UNSIGNED_INT:return G.UINT;case t.UNSIGNED_INT_VEC2:return G.UINT2;case t.UNSIGNED_INT_VEC3:return G.UINT3;case t.UNSIGNED_INT_VEC4:return G.UINT4;case t.FLOAT:return G.FLOAT;case t.FLOAT_VEC2:return G.FLOAT2;case t.FLOAT_VEC3:return G.FLOAT3;case t.FLOAT_VEC4:return G.FLOAT4;case t.FLOAT_MAT2:return G.MAT2;case t.FLOAT_MAT2x3:return G.MAT2X3;case t.FLOAT_MAT2x4:return G.MAT2X4;case t.FLOAT_MAT3x2:return G.MAT3X2;case t.FLOAT_MAT3:return G.MAT3;case t.FLOAT_MAT3x4:return G.MAT3X4;case t.FLOAT_MAT4x2:return G.MAT4X2;case t.FLOAT_MAT4x3:return G.MAT4X3;case t.FLOAT_MAT4:return G.MAT4;case t.SAMPLER_2D:return G.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return G.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return G.SAMPLER3D;case t.SAMPLER_CUBE:return G.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),G.UNKNOWN}}function Be(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Ce(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var me,xe=[512,513,514,515,516,517,518,519],be=[0,7680,7681,7682,7683,5386,34055,34056],Fe=[32774,32778,32779,32775,32776],Pe=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(me||(me={}));var Ie=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Ge=function(e){function r(){var t;return(t=e.call(this,me.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new g,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(Ie),Me=function(e){function r(){var t;return(t=e.call(this,me.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.viewport=null,t.scissor=null,t.lineWidth=null,t.depthBias=null,t.blendConstants=[],t.depthBounds=null,t.stencilWriteMask=null,t.stencilCompareMask=null,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null},r}(Ie),Oe=function(e){function r(){var t;return(t=e.call(this,me.DRAW)||this).drawInfo=new R,t}return t(r,e),r.prototype.clear=function(){},r}(Ie),ve=function(e){function r(){var t;return(t=e.call(this,me.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(Ie),De=function(e){function r(){var t;return(t=e.call(this,me.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(Ie),Le=function(){function e(){this.cmds=new a(1),this.beginRenderPassCmds=new a(1),this.bindStatesCmds=new a(1),this.drawCmds=new a(1),this.updateBufferCmds=new a(1),this.copyBufferToTextureCmds=new a(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function Ue(e,t,r,s,i){if(t.usage&E.INDIRECT)t.indirects.length=s,Array.prototype.push.apply(t.indirects,r.drawInfos);else{var a=r,n=e.gl,u=e.stateCache;switch(t.glTarget){case n.ARRAY_BUFFER:u.glVAO&&(n.bindVertexArray(null),u.glVAO=Ne.gpuInputAssembler=null),u.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),u.glArrayBuffer=t.glBuffer),i===a.byteLength?n.bufferSubData(t.glTarget,s,a):n.bufferSubData(t.glTarget,s,a.slice(0,i));break;case n.ELEMENT_ARRAY_BUFFER:u.glVAO&&(n.bindVertexArray(null),u.glVAO=Ne.gpuInputAssembler=null),u.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),u.glElementArrayBuffer=t.glBuffer),i===a.byteLength?n.bufferSubData(t.glTarget,s,a):n.bufferSubData(t.glTarget,s,a.slice(0,i));break;case n.UNIFORM_BUFFER:u.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),u.glUniformBuffer=t.glBuffer),i===a.byteLength?n.bufferSubData(t.glTarget,s,a):n.bufferSubData(t.glTarget,s,new Float32Array(a,0,i/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}var Ne={gpuPipelineState:null,gpuInputAssembler:null,reverseCW:!1,glPrimitive:0,invalidateAttachments:[]};function ye(e,t,r,s,i,a,n){var u=e.gl,l=e.stateCache,_=0;if(r&&t){if(l.glFramebuffer!==r.glFramebuffer){u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),l.glFramebuffer=r.glFramebuffer;var c=!!r.glFramebuffer;if(c!==Ne.reverseCW){Ne.reverseCW=c;var o=!e.stateCache.rs.isFrontFaceCCW;u.frontFace(o?u.CCW:u.CW),e.stateCache.rs.isFrontFaceCCW=o}}l.viewport.left===s.x&&l.viewport.top===s.y&&l.viewport.width===s.width&&l.viewport.height===s.height||(u.viewport(s.x,s.y,s.width,s.height),l.viewport.left=s.x,l.viewport.top=s.y,l.viewport.width=s.width,l.viewport.height=s.height),l.scissorRect.x===s.x&&l.scissorRect.y===s.y&&l.scissorRect.width===s.width&&l.scissorRect.height===s.height||(u.scissor(s.x,s.y,s.width,s.height),l.scissorRect.x=s.x,l.scissorRect.y=s.y,l.scissorRect.width=s.width,l.scissorRect.height=s.height),Ne.invalidateAttachments.length=0;for(var f=0;f<i.length;++f){var h=t.colorAttachments[f];if(h.format!==d.UNKNOWN)switch(h.loadOp){case m.LOAD:break;case m.CLEAR:if(l.bs.targets[0].blendColorMask!==x.ALL&&u.colorMask(!0,!0,!0,!0),r.isOffscreen)Re[0]=i[f].x,Re[1]=i[f].y,Re[2]=i[f].z,Re[3]=i[f].w,u.clearBufferfv(u.COLOR,f,Re);else{var g=i[0];u.clearColor(g.x,g.y,g.z,g.w),_|=u.COLOR_BUFFER_BIT}break;case m.DISCARD:Ne.invalidateAttachments.push(u.COLOR_ATTACHMENT0+f)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==d.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case m.LOAD:break;case m.CLEAR:l.dss.depthWrite||u.depthMask(!0),u.clearDepth(a),_|=u.DEPTH_BUFFER_BIT;break;case m.DISCARD:Ne.invalidateAttachments.push(u.DEPTH_ATTACHMENT)}if(T[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case m.LOAD:break;case m.CLEAR:l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),_|=u.STENCIL_BUFFER_BIT;break;case m.DISCARD:Ne.invalidateAttachments.push(u.STENCIL_ATTACHMENT)}}if(r.glFramebuffer&&Ne.invalidateAttachments.length&&u.invalidateFramebuffer(u.FRAMEBUFFER,Ne.invalidateAttachments),_&&u.clear(_),_&u.COLOR_BUFFER_BIT){var R=l.bs.targets[0].blendColorMask;if(R!==x.ALL){var A=(R&x.R)!==x.NONE,E=(R&x.G)!==x.NONE,p=(R&x.B)!==x.NONE,S=(R&x.A)!==x.NONE;u.colorMask(A,E,p,S)}}_&u.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&u.depthMask(!1),_&u.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function we(e,t,r,s,a,n,u,l,_,c,o,f,h){var d=e.gl,g=e.stateCache,R=t&&t.gpuShader,A=!1;if(t&&Ne.gpuPipelineState!==t){if(Ne.gpuPipelineState=t,Ne.glPrimitive=t.glPrimitive,R){var E=R.glProgram;g.glProgram!==E&&(d.useProgram(E),g.glProgram=E,A=!0)}var p=t.rs;if(p){if(g.rs.cullMode!==p.cullMode){switch(p.cullMode){case b.NONE:d.disable(d.CULL_FACE);break;case b.FRONT:d.enable(d.CULL_FACE),d.cullFace(d.FRONT);break;case b.BACK:d.enable(d.CULL_FACE),d.cullFace(d.BACK)}e.stateCache.rs.cullMode=p.cullMode}var T=p.isFrontFaceCCW!==Ne.reverseCW;e.stateCache.rs.isFrontFaceCCW!==T&&(d.frontFace(T?d.CCW:d.CW),e.stateCache.rs.isFrontFaceCCW=T),e.stateCache.rs.depthBias===p.depthBias&&e.stateCache.rs.depthBiasSlop===p.depthBiasSlop||(d.polygonOffset(p.depthBias,p.depthBiasSlop),e.stateCache.rs.depthBias=p.depthBias,e.stateCache.rs.depthBiasSlop=p.depthBiasSlop),e.stateCache.rs.lineWidth!==p.lineWidth&&(d.lineWidth(p.lineWidth),e.stateCache.rs.lineWidth=p.lineWidth)}var S=t.dss;S&&(g.dss.depthTest!==S.depthTest&&(S.depthTest?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),g.dss.depthTest=S.depthTest),g.dss.depthWrite!==S.depthWrite&&(d.depthMask(S.depthWrite),g.dss.depthWrite=S.depthWrite),g.dss.depthFunc!==S.depthFunc&&(d.depthFunc(xe[S.depthFunc]),g.dss.depthFunc=S.depthFunc),g.dss.stencilTestFront===S.stencilTestFront&&g.dss.stencilTestBack===S.stencilTestBack||(S.stencilTestFront||S.stencilTestBack?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),g.dss.stencilTestFront=S.stencilTestFront,g.dss.stencilTestBack=S.stencilTestBack),g.dss.stencilFuncFront===S.stencilFuncFront&&g.dss.stencilRefFront===S.stencilRefFront&&g.dss.stencilReadMaskFront===S.stencilReadMaskFront||(d.stencilFuncSeparate(d.FRONT,xe[S.stencilFuncFront],S.stencilRefFront,S.stencilReadMaskFront),g.dss.stencilFuncFront=S.stencilFuncFront,g.dss.stencilRefFront=S.stencilRefFront,g.dss.stencilReadMaskFront=S.stencilReadMaskFront),g.dss.stencilFailOpFront===S.stencilFailOpFront&&g.dss.stencilZFailOpFront===S.stencilZFailOpFront&&g.dss.stencilPassOpFront===S.stencilPassOpFront||(d.stencilOpSeparate(d.FRONT,be[S.stencilFailOpFront],be[S.stencilZFailOpFront],be[S.stencilPassOpFront]),g.dss.stencilFailOpFront=S.stencilFailOpFront,g.dss.stencilZFailOpFront=S.stencilZFailOpFront,g.dss.stencilPassOpFront=S.stencilPassOpFront),g.dss.stencilWriteMaskFront!==S.stencilWriteMaskFront&&(d.stencilMaskSeparate(d.FRONT,S.stencilWriteMaskFront),g.dss.stencilWriteMaskFront=S.stencilWriteMaskFront),g.dss.stencilFuncBack===S.stencilFuncBack&&g.dss.stencilRefBack===S.stencilRefBack&&g.dss.stencilReadMaskBack===S.stencilReadMaskBack||(d.stencilFuncSeparate(d.BACK,xe[S.stencilFuncBack],S.stencilRefBack,S.stencilReadMaskBack),g.dss.stencilFuncBack=S.stencilFuncBack,g.dss.stencilRefBack=S.stencilRefBack,g.dss.stencilReadMaskBack=S.stencilReadMaskBack),g.dss.stencilFailOpBack===S.stencilFailOpBack&&g.dss.stencilZFailOpBack===S.stencilZFailOpBack&&g.dss.stencilPassOpBack===S.stencilPassOpBack||(d.stencilOpSeparate(d.BACK,be[S.stencilFailOpBack],be[S.stencilZFailOpBack],be[S.stencilPassOpBack]),g.dss.stencilFailOpBack=S.stencilFailOpBack,g.dss.stencilZFailOpBack=S.stencilZFailOpBack,g.dss.stencilPassOpBack=S.stencilPassOpBack),g.dss.stencilWriteMaskBack!==S.stencilWriteMaskBack&&(d.stencilMaskSeparate(d.BACK,S.stencilWriteMaskBack),g.dss.stencilWriteMaskBack=S.stencilWriteMaskBack));var B=t.bs;if(B){g.bs.isA2C!==B.isA2C&&(B.isA2C?d.enable(d.SAMPLE_ALPHA_TO_COVERAGE):d.disable(d.SAMPLE_ALPHA_TO_COVERAGE),g.bs.isA2C=B.isA2C),g.bs.blendColor.x===B.blendColor.x&&g.bs.blendColor.y===B.blendColor.y&&g.bs.blendColor.z===B.blendColor.z&&g.bs.blendColor.w===B.blendColor.w||(d.blendColor(B.blendColor.x,B.blendColor.y,B.blendColor.z,B.blendColor.w),g.bs.blendColor.x=B.blendColor.x,g.bs.blendColor.y=B.blendColor.y,g.bs.blendColor.z=B.blendColor.z,g.bs.blendColor.w=B.blendColor.w);var C=B.targets[0],m=g.bs.targets[0];m.blend!==C.blend&&(C.blend?d.enable(d.BLEND):d.disable(d.BLEND),m.blend=C.blend),m.blendEq===C.blendEq&&m.blendAlphaEq===C.blendAlphaEq||(d.blendEquationSeparate(Fe[C.blendEq],Fe[C.blendAlphaEq]),m.blendEq=C.blendEq,m.blendAlphaEq=C.blendAlphaEq),m.blendSrc===C.blendSrc&&m.blendDst===C.blendDst&&m.blendSrcAlpha===C.blendSrcAlpha&&m.blendDstAlpha===C.blendDstAlpha||(d.blendFuncSeparate(Pe[C.blendSrc],Pe[C.blendDst],Pe[C.blendSrcAlpha],Pe[C.blendDstAlpha]),m.blendSrc=C.blendSrc,m.blendDst=C.blendDst,m.blendSrcAlpha=C.blendSrcAlpha,m.blendDstAlpha=C.blendDstAlpha),m.blendColorMask!==C.blendColorMask&&(d.colorMask((C.blendColorMask&x.R)!==x.NONE,(C.blendColorMask&x.G)!==x.NONE,(C.blendColorMask&x.B)!==x.NONE,(C.blendColorMask&x.A)!==x.NONE),m.blendColorMask=C.blendColorMask)}}if(t&&t.gpuPipelineLayout&&R){for(var I=R.glBlocks.length,G=t.gpuPipelineLayout.dynamicOffsetIndices,M=0;M<I;M++){var O=R.glBlocks[M],v=s[O.set],D=v&&v.descriptorIndices[O.binding],L=D>=0&&v.gpuDescriptors[D];if(L&&L.gpuBuffer){var U=G[O.set],N=U&&U[O.binding],y=L.gpuBuffer.glOffset;N>=0&&(y+=a[N]),g.glBindUBOs[O.glBinding]===L.gpuBuffer.glBuffer&&g.glBindUBOOffsets[O.glBinding]===y||(y?d.bindBufferRange(d.UNIFORM_BUFFER,O.glBinding,L.gpuBuffer.glBuffer,y,L.gpuBuffer.size):d.bindBufferBase(d.UNIFORM_BUFFER,O.glBinding,L.gpuBuffer.glBuffer),g.glUniformBuffer=g.glBindUBOs[O.glBinding]=L.gpuBuffer.glBuffer,g.glBindUBOOffsets[O.glBinding]=y)}else i("Buffer binding '"+O.name+"' at set "+O.set+" binding "+O.binding+" is not bounded")}for(var w=R.glSamplers.length,k=0;k<w;k++)for(var V=R.glSamplers[k],W=s[V.set],H=W&&W.descriptorIndices[V.binding],X=H>=0&&W.gpuDescriptors[H],z=0;z<V.units.length;z++){var K=V.units[z],Y=g.glTexUnits[K];if(X&&X.gpuTexture&&X.gpuSampler){if(X.gpuTexture&&X.gpuTexture.size>0){var q=X.gpuTexture;Y.glTexture!==q.glTexture&&(g.texUnit!==K&&(d.activeTexture(d.TEXTURE0+K),g.texUnit=K),q.glTexture?d.bindTexture(q.glTarget,q.glTexture):d.bindTexture(q.glTarget,e.nullTex2D.gpuTexture.glTexture),Y.glTexture=q.glTexture);var Z=X.gpuSampler;g.glSamplerUnits[K]!==Z.glSampler&&(d.bindSampler(K,Z.glSampler),g.glSamplerUnits[K]=Z.glSampler)}X=W.gpuDescriptors[++H]}else i("Sampler binding '"+V.name+"' at set "+V.set+" binding "+V.binding+" index "+z+" is not bounded")}}if(r&&R&&(A||Ne.gpuInputAssembler!==r))if(Ne.gpuInputAssembler=r,e.useVAO){var j=r.glVAOs.get(R.glProgram);if(!j){var Q;j=d.createVertexArray(),r.glVAOs.set(R.glProgram,j),d.bindVertexArray(j),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),g.glArrayBuffer=null,g.glElementArrayBuffer=null;for(var J=0;J<R.glInputs.length;J++){var $=R.glInputs[J];Q=null;for(var ee=0;ee<r.glAttribs.length;ee++){var te=r.glAttribs[ee];if(te.name===$.name){Q=te;break}}if(Q){g.glArrayBuffer!==Q.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,Q.glBuffer),g.glArrayBuffer=Q.glBuffer);for(var re=0;re<Q.componentCount;++re){var se=$.glLoc+re,ie=Q.offset+Q.size*re;d.enableVertexAttribArray(se),g.glCurrentAttribLocs[se]=!0,d.vertexAttribPointer(se,Q.count,Q.glType,Q.isNormalized,Q.stride,ie),d.vertexAttribDivisor(se,Q.isInstanced?1:0)}}}var ae=r.gpuIndexBuffer;ae&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,ae.glBuffer),d.bindVertexArray(null),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),g.glArrayBuffer=null,g.glElementArrayBuffer=null}g.glVAO!==j&&(d.bindVertexArray(j),g.glVAO=j)}else{for(var ne=0;ne<e.maxVertexAttributes;++ne)g.glCurrentAttribLocs[ne]=!1;for(var ue=0;ue<R.glInputs.length;ue++){for(var le=R.glInputs[ue],_e=null,ce=0;ce<r.glAttribs.length;ce++){var oe=r.glAttribs[ce];if(oe.name===le.name){_e=oe;break}}if(_e){g.glArrayBuffer!==_e.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,_e.glBuffer),g.glArrayBuffer=_e.glBuffer);for(var fe=0;fe<_e.componentCount;++fe){var he=le.glLoc+fe,de=_e.offset+_e.size*fe;!g.glEnabledAttribLocs[he]&&he>=0&&(d.enableVertexAttribArray(he),g.glEnabledAttribLocs[he]=!0),g.glCurrentAttribLocs[he]=!0,d.vertexAttribPointer(he,_e.count,_e.glType,_e.isNormalized,_e.stride,de),d.vertexAttribDivisor(he,_e.isInstanced?1:0)}}}var ge=r.gpuIndexBuffer;ge&&g.glElementArrayBuffer!==ge.glBuffer&&(d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,ge.glBuffer),g.glElementArrayBuffer=ge.glBuffer);for(var Re=0;Re<e.maxVertexAttributes;++Re)g.glEnabledAttribLocs[Re]!==g.glCurrentAttribLocs[Re]&&(d.disableVertexAttribArray(Re),g.glEnabledAttribLocs[Re]=!1)}if(t&&t.dynamicStates.length)for(var Ae=t.dynamicStates.length,Ee=0;Ee<Ae;Ee++)switch(t.dynamicStates[Ee]){case F.VIEWPORT:n&&(g.viewport.left===n.left&&g.viewport.top===n.top&&g.viewport.width===n.width&&g.viewport.height===n.height||(d.viewport(n.left,n.top,n.width,n.height),g.viewport.left=n.left,g.viewport.top=n.top,g.viewport.width=n.width,g.viewport.height=n.height));break;case F.SCISSOR:u&&(g.scissorRect.x===u.x&&g.scissorRect.y===u.y&&g.scissorRect.width===u.width&&g.scissorRect.height===u.height||(d.scissor(u.x,u.y,u.width,u.height),g.scissorRect.x=u.x,g.scissorRect.y=u.y,g.scissorRect.width=u.width,g.scissorRect.height=u.height));break;case F.LINE_WIDTH:l&&g.rs.lineWidth!==l&&(d.lineWidth(l),g.rs.lineWidth=l);break;case F.DEPTH_BIAS:_&&(g.rs.depthBias===_.constantFactor&&g.rs.depthBiasSlop===_.slopeFactor||(d.polygonOffset(_.constantFactor,_.slopeFactor),g.rs.depthBias=_.constantFactor,g.rs.depthBiasSlop=_.slopeFactor));break;case F.BLEND_CONSTANTS:g.bs.blendColor.x===c[0]&&g.bs.blendColor.y===c[1]&&g.bs.blendColor.z===c[2]&&g.bs.blendColor.w===c[3]||(d.blendColor(c[0],c[1],c[2],c[3]),g.bs.blendColor.x=c[0],g.bs.blendColor.y=c[1],g.bs.blendColor.z=c[2],g.bs.blendColor.w=c[3]);break;case F.STENCIL_WRITE_MASK:if(f)switch(f.face){case P.FRONT:g.dss.stencilWriteMaskFront!==f.writeMask&&(d.stencilMaskSeparate(d.FRONT,f.writeMask),g.dss.stencilWriteMaskFront=f.writeMask);break;case P.BACK:g.dss.stencilWriteMaskBack!==f.writeMask&&(d.stencilMaskSeparate(d.BACK,f.writeMask),g.dss.stencilWriteMaskBack=f.writeMask);break;case P.ALL:g.dss.stencilWriteMaskFront===f.writeMask&&g.dss.stencilWriteMaskBack===f.writeMask||(d.stencilMask(f.writeMask),g.dss.stencilWriteMaskFront=f.writeMask,g.dss.stencilWriteMaskBack=f.writeMask)}break;case F.STENCIL_COMPARE_MASK:if(h)switch(h.face){case P.FRONT:g.dss.stencilRefFront===h.reference&&g.dss.stencilReadMaskFront===h.compareMask||(d.stencilFuncSeparate(d.FRONT,xe[g.dss.stencilFuncFront],h.reference,h.compareMask),g.dss.stencilRefFront=h.reference,g.dss.stencilReadMaskFront=h.compareMask);break;case P.BACK:g.dss.stencilRefBack===h.reference&&g.dss.stencilReadMaskBack===h.compareMask||(d.stencilFuncSeparate(d.BACK,xe[g.dss.stencilFuncBack],h.reference,h.compareMask),g.dss.stencilRefBack=h.reference,g.dss.stencilReadMaskBack=h.compareMask);break;case P.ALL:g.dss.stencilRefFront===h.reference&&g.dss.stencilReadMaskFront===h.compareMask&&g.dss.stencilRefBack===h.reference&&g.dss.stencilReadMaskBack===h.compareMask||(d.stencilFunc(xe[g.dss.stencilFuncBack],h.reference,h.compareMask),g.dss.stencilRefFront=h.reference,g.dss.stencilReadMaskFront=h.compareMask,g.dss.stencilRefBack=h.reference,g.dss.stencilReadMaskBack=h.compareMask)}}}function ke(e,t){var r=e.gl,s=Ne.gpuInputAssembler,i=Ne.glPrimitive;if(s)if(s.gpuIndirectBuffer)for(var a=s.gpuIndirectBuffer.indirects,n=0;n<a.length;n++){var u=a[n],l=s.gpuIndexBuffer;if(u.instanceCount)if(l){if(u.indexCount>0){var _=u.firstIndex*l.stride;r.drawElementsInstanced(i,u.indexCount,s.glIndexType,_,u.instanceCount)}}else u.vertexCount>0&&r.drawArraysInstanced(i,u.firstVertex,u.vertexCount,u.instanceCount);else if(l){if(u.indexCount>0){var c=u.firstIndex*l.stride;r.drawElements(i,u.indexCount,s.glIndexType,c)}}else u.vertexCount>0&&r.drawArrays(i,u.firstVertex,u.vertexCount)}else if(t.instanceCount)if(s.gpuIndexBuffer){if(t.indexCount>0){var o=t.firstIndex*s.gpuIndexBuffer.stride;r.drawElementsInstanced(i,t.indexCount,s.glIndexType,o,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstanced(i,t.firstVertex,t.vertexCount,t.instanceCount);else if(s.gpuIndexBuffer){if(t.indexCount>0){var f=t.firstIndex*s.gpuIndexBuffer.stride;r.drawElements(i,t.indexCount,s.glIndexType,f)}}else t.vertexCount>0&&r.drawArrays(i,t.firstVertex,t.vertexCount)}var Ve=new Array(me.COUNT);function We(e,t){Ve.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],i=Ve[s]++;switch(s){case me.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[i];ye(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case me.BIND_STATES:var n=t.bindStatesCmds.array[i];we(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.viewport,n.scissor,n.lineWidth,n.depthBias,n.blendConstants,n.depthBounds,n.stencilWriteMask,n.stencilCompareMask);break;case me.DRAW:ke(e,t.drawCmds.array[i].drawInfo);break;case me.UPDATE_BUFFER:var u=t.updateBufferCmds.array[i];Ue(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case me.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[i];He(e,l.buffers,l.gpuTexture,l.regions)}}}function He(e,t,r,s){var i=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==r.glTexture&&(i.bindTexture(r.glTarget,r.glTexture),a.glTexture=r.glTexture);var n=0,u=1,l=1,_=0,c=T[r.format].isCompressed;switch(r.glTarget){case i.TEXTURE_2D:for(var o=0;o<s.length;o++){var f=s[o];u=f.texExtent.width,l=f.texExtent.height;var h=t[n++];c?r.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL?i.compressedTexSubImage2D(i.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,u,l,r.glFormat,h):i.compressedTexImage2D(i.TEXTURE_2D,f.texSubres.mipLevel,r.glInternalFmt,u,l,0,h):i.texSubImage2D(i.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,u,l,r.glFormat,r.glType,h)}break;case i.TEXTURE_CUBE_MAP:for(var d=0;d<s.length;d++){var g=s[d],R=g.texSubres.baseArrayLayer+g.texSubres.layerCount;for(_=g.texSubres.baseArrayLayer;_<R;++_){u=g.texExtent.width,l=g.texExtent.height;var A=t[n++];c?r.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL?i.compressedTexSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,g.texOffset.x,g.texOffset.y,u,l,r.glFormat,A):i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,r.glInternalFmt,u,l,0,A):i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,g.texOffset.x,g.texOffset.y,u,l,r.glFormat,r.glType,A)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&I.GEN_MIPMAP&&i.generateMipmap(r.glTarget)}var Xe=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&E.INDIRECT&&(this._indirectBuffer=new O),this._flags&v.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&E.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var r=e.gl,s=e.stateCache,i=t.memUsage&A.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&E.VERTEX){t.glTarget=r.ARRAY_BUFFER;var a=r.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=Ne.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&E.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=Ne.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&E.UNIFORM){t.glTarget=r.UNIFORM_BUFFER;var u=r.createBuffer();u&&t.size>0&&(t.glBuffer=u,e.stateCache.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),r.bufferData(r.UNIFORM_BUFFER,t.size,i),r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&E.INDIRECT||t.usage&E.TRANSFER_DST||t.usage&E.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0},i.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var r=e.gl;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=Ne.gpuInputAssembler=null),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=Ne.gpuInputAssembler=null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case r.UNIFORM_BUFFER:r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null),this._bakcupBuffer=null},i.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){var r=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(r),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}var s,i,a,n,u;this._gpuBuffer&&(this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(s=this._device,i=this._gpuBuffer,a=s.gl,n=s.stateCache,u=i.memUsage&A.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,i.usage&E.VERTEX?(s.useVAO&&n.glVAO&&(a.bindVertexArray(null),n.glVAO=Ne.gpuInputAssembler=null),n.glArrayBuffer!==i.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,i.glBuffer),i.buffer?a.bufferData(a.ARRAY_BUFFER,i.buffer,u):a.bufferData(a.ARRAY_BUFFER,i.size,u),a.bindBuffer(a.ARRAY_BUFFER,null),n.glArrayBuffer=null):i.usage&E.INDEX?(s.useVAO&&n.glVAO&&(a.bindVertexArray(null),n.glVAO=Ne.gpuInputAssembler=null),s.stateCache.glElementArrayBuffer!==i.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i.glBuffer),i.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,i.buffer,u):a.bufferData(a.ELEMENT_ARRAY_BUFFER,i.size,u),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.stateCache.glElementArrayBuffer=null):i.usage&E.UNIFORM?(s.stateCache.glUniformBuffer!==i.glBuffer&&a.bindBuffer(a.UNIFORM_BUFFER,i.glBuffer),a.bufferData(a.UNIFORM_BUFFER,i.size,u),a.bindBuffer(a.UNIFORM_BUFFER,null),s.stateCache.glUniformBuffer=null):(i.usage&E.INDIRECT||i.usage&E.TRANSFER_DST||i.usage&E.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),i.glTarget=a.NONE),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}},i.update=function(e,t,r){if(this._isBufferView)console.warn("cannot update through buffer views!");else{var s;if(s=void 0!==r?r:this._usage&E.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){var i=new Uint8Array(e,0,r);this._bakcupBuffer.set(i,t)}Ue(this._device,this._gpuBuffer,e,t||0,s)}},r(s,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),s}(D),ze=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new a(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,i=0;i<s;++i)this._frees[i]=new e;for(var a=s,n=0;a<t;++a,++n)this._frees[a]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),Ke=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new ze(Ge,1),this.bindStatesCmdPool=new ze(Me,1),this.drawCmdPool=new ze(Oe,1),this.updateBufferCmdPool=new ze(ve,1),this.copyBufferToTextureCmdPool=new ze(De,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Ye=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new Le,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=[],t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}t(s,e);var i=s.prototype;return i.initialize=function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0},i.destroy=function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)},i.begin=function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)this._curDynamicOffsets[e].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},i.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},i.beginRenderPass=function(e,t,r,s,i,a){var n=this._webGLAllocator.beginRenderPassCmdPool.alloc(Ge);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea=r;for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=i,n.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(me.BEGIN_RENDER_PASS),this._isInRenderPass=!0},i.endRenderPass=function(){this._isInRenderPass=!1},i.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},i.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){for(var i=this._curDynamicOffsets[e],a=0;a<r.length;a++)i[a]=r[a];i.length=r.length,this._isStateInvalied=!0}},i.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},i.setViewport=function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport=new L(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth)},i.setScissor=function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor=new g(e.x,e.y,e.width,e.height)},i.setLineWidth=function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)},i.setDepthBias=function(e,t,r){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===r||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=r,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:r},this._isStateInvalied=!0)},i.setBlendConstants=function(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)},i.setDepthBound=function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)},i.setStencilWriteMask=function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)},i.setStencilCompareMask=function(e,t,r){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===r||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=r,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:r},this._isStateInvalied=!0)},i.draw=function(e){if(this._type===U.PRIMARY&&this._isInRenderPass||this._type===U.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(Oe);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(me.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var r=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},i.updateBuffer=function(e,t,r,s){if(this._type===U.PRIMARY&&!this._isInRenderPass||this._type===U.SECONDARY){var i=e.gpuBuffer;if(i){var a,n=this._webGLAllocator.updateBufferCmdPool.alloc(ve),u=0;e.usage&E.INDIRECT||(u=void 0!==s?s:t.byteLength),a=t,n.gpuBuffer=i,n.buffer=a,n.offset=void 0!==r?r:0,n.size=u,this.cmdPackage.updateBufferCmds.push(n),this.cmdPackage.cmds.push(me.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},i.copyBuffersToTexture=function(e,t,r){if(this._type===U.PRIMARY&&!this._isInRenderPass||this._type===U.SECONDARY){var s=t.gpuTexture;if(s){var i=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(De);i.gpuTexture=s,i.regions=r,i.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(i),this.cmdPackage.cmds.push(me.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},i.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],i=0;i<s.cmdPackage.beginRenderPassCmds.length;++i){var a=s.cmdPackage.beginRenderPassCmds.array[i];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var l=0;l<s.cmdPackage.drawCmds.length;++l){var _=s.cmdPackage.drawCmds.array[l];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var o=s.cmdPackage.updateBufferCmds.array[c];++o.refCount,this.cmdPackage.updateBufferCmds.push(o)}for(var f=0;f<s.cmdPackage.copyBufferToTextureCmds.length;++f){var h=s.cmdPackage.copyBufferToTextureCmds.array[f];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},i.bindStates=function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Me);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(var t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(me.BIND_STATES),this._isStateInvalied=!1},r(s,[{key:"webGLDevice",get:function(){return this._device}}]),s}(N),qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._sync=null,t}t(r,e);var s=r.prototype;return s.initialize=function(){return!0},s.destroy=function(){},s.wait=function(){if(this._sync){var e=this._device.gl;e.clientWaitSync(this._sync,0,e.TIMEOUT_IGNORED)}},s.reset=function(){this._sync&&(this._device.gl.deleteSync(this._sync),this._sync=null)},s.insert=function(){var e=this._device.gl;this._sync&&e.deleteSync(this._sync),this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)},r}(y),Ze=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment "+t+" should be 0. Convert to 0.");for(var r=[],s=0;s<e.colorTextures.length;s++){var i=e.colorTextures[s];i&&r.push(i.gpuTexture)}var a=null;return e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:a,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var r=e.gl,s=[],i=r.createFramebuffer();if(i){t.glFramebuffer=i,e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var n=t.gpuColorTextures[a];n&&(n.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+a,n.glTarget,n.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+a,r.RENDERBUFFER,n.glRenderbuffer),s.push(r.COLOR_ATTACHMENT0+a))}var u=t.gpuDepthStencilTexture;if(u){var l=T[u.format].hasStencil?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT;u.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,l,u.glTarget,u.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,l,r.RENDERBUFFER,u.glRenderbuffer)}r.drawBuffers(s);var _=r.checkFramebufferStatus(r.FRAMEBUFFER);if(_!==r.FRAMEBUFFER_COMPLETE)switch(_){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case r.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0},i.destroy=function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(s,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),s}(w),je=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var i=e.vertexBuffers[s];i.gpuBuffer&&(r[s]=i.gpuBuffer)}var a=null,n=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}var u=null;return e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:a,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],i=0;i<t.attributes.length;++i){var a=t.attributes[i],n=void 0!==a.stream?a.stream:0,u=t.gpuVertexBuffers[n],l=Ae(a.format,r),_=T[a.format].size;t.glAttribs[i]={name:a.name,glBuffer:u.glBuffer,glType:l,size:_,count:T[a.format].count,stride:u.stride,componentCount:Ce(l,r),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:s[n]},s[n]+=_}}(this._device,this._gpuInputAssembler),!0},i.destroy=function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next();!s.done;)e.gl.deleteVertexArray(s.value),s=r.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(k),Qe=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],i=0;i<this._bindings.length;i++){var a=this._bindings[i];s.push(t),t+=a.count,a.binding>r&&(r=a.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var l=this._bindings[u];this._bindingIndices[l.binding]=u,n[l.binding]=s[u]}for(var _=[],c=0;c<this._bindings.length;c++){var o=this._bindings[c];if(o.descriptorType&V)for(var f=0;f<o.count;f++)_.push(o.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:n,descriptorCount:t},!0},i.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}(W),Je=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,i=0;i<this._setLayouts.length;i++){for(var a=this._setLayouts[i],n=a.gpuDescriptorSetLayout.dynamicBindings,u=Array(a.bindingIndices.length).fill(-1),l=0;l<n.length;l++){var _=n[l];u[_]<0&&(u[_]=s+l)}r.push(a.gpuDescriptorSetLayout),t.push(u),s+=n.length}return this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s},!0},i.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(H),$e=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],et=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var t=[],r=0;r<31;r++)this._dynamicStates&1<<r&&t.push(1<<r);return this._gpuPipelineState={glPrimitive:$e[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0},i.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(X),tt=[],rt=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,i,a){ye(this._device,e.gpuRenderPass,t.gpuFramebuffer,r,s,i,a),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),ke(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r,s){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,a=e.gpuBuffer;a&&(void 0===r&&(r=0),i=void 0!==s?s:e.usage&E.INDIRECT?0:t.byteLength,Ue(this._device,a,t,r,i))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&He(this._device,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];We(this._device,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){tt.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(tt,this._curDynamicOffsets[e]);we(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,tt,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1},r}(Ye),st=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return this._type=e.type,!0},s.destroy=function(){},s.submit=function(e,t){if(!this._isAsync)for(var r=0;r<e.length;r++){var s=e[r];this.numDrawCalls+=s.numDrawCalls,this.numInstances+=s.numInstances,this.numTris+=s.numTris}t&&t.insert()},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(z),it=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0},i.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(K),at=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuSampler=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){var t,r,s,i;return this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._minLOD=e.minLOD,this._maxLOD=e.maxLOD,this._mipLODBias=e.mipLODBias,this._gpuSampler={glSampler:null,minFilter:this._minFilter,magFilter:this._magFilter,mipFilter:this._mipFilter,addressU:this._addressU,addressV:this._addressV,addressW:this._addressW,minLOD:this._minLOD,maxLOD:this._maxLOD,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},t=this._device,r=this._gpuSampler,(i=(s=t.gl).createSampler())&&(r.minFilter===C.LINEAR||r.minFilter===C.ANISOTROPIC?r.mipFilter===C.LINEAR||r.mipFilter===C.ANISOTROPIC?r.glMinFilter=s.LINEAR_MIPMAP_LINEAR:r.mipFilter===C.POINT?r.glMinFilter=s.LINEAR_MIPMAP_NEAREST:r.glMinFilter=s.LINEAR:r.mipFilter===C.LINEAR||r.mipFilter===C.ANISOTROPIC?r.glMinFilter=s.NEAREST_MIPMAP_LINEAR:r.mipFilter===C.POINT?r.glMinFilter=s.NEAREST_MIPMAP_NEAREST:r.glMinFilter=s.NEAREST,r.magFilter===C.LINEAR||r.magFilter===C.ANISOTROPIC?r.glMagFilter=s.LINEAR:r.glMagFilter=s.NEAREST,r.glWrapS=de[r.addressU],r.glWrapT=de[r.addressV],r.glWrapR=de[r.addressW],r.glSampler=i,s.samplerParameteri(i,s.TEXTURE_MIN_FILTER,r.glMinFilter),s.samplerParameteri(i,s.TEXTURE_MAG_FILTER,r.glMagFilter),s.samplerParameteri(i,s.TEXTURE_WRAP_S,r.glWrapS),s.samplerParameteri(i,s.TEXTURE_WRAP_T,r.glWrapT),s.samplerParameteri(i,s.TEXTURE_WRAP_R,r.glWrapR),s.samplerParameterf(i,s.TEXTURE_MIN_LOD,r.minLOD),s.samplerParameterf(i,s.TEXTURE_MAX_LOD,r.maxLOD)),!0},i.destroy=function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}(Y),nt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplers:e.samplers,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}return function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],i=0,a="",n=1;switch(s.type){case M.VERTEX:a="VertexShader",i=r.VERTEX_SHADER;break;case M.FRAGMENT:a="FragmentShader",i=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(i);if(u&&(s.glShader=u,r.shaderSource(s.glShader,"#version 300 es\n"+s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[e];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var n=s(a);if("object"==typeof n)return n.v}var u=r.createProgram();if(u){t.glProgram=u;for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[l];r.attachShader(t.glProgram,_.glShader)}r.linkProgram(t.glProgram);for(var c=0;c<t.gpuStages.length;c++){var o=t.gpuStages[c];o.glShader&&(r.detachShader(t.glProgram,o.glShader),r.deleteShader(o.glShader),o.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");var f=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(f);for(var h=0;h<f;++h){var d=r.getActiveAttrib(t.glProgram,h);if(d){var g,R=d.name.indexOf("[");g=-1!==R?d.name.substr(0,R):d.name;var A=r.getAttribLocation(t.glProgram,g),E=Se(d.type,r),p=Be(d.type,r);t.glInputs[h]={name:g,type:E,stride:p,count:d.size,size:p*d.size,glType:d.type,glLoc:A}}}var T,S,B,C,m=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORM_BLOCKS);if(m){t.glBlocks=new Array(m);for(var x=0;x<m;++x){var b=(T=r.getActiveUniformBlockName(t.glProgram,x)).indexOf("[");-1!==b&&(T=T.substr(0,b)),C=null;for(var F=0;F<t.blocks.length;F++)if(t.blocks[F].name===T){C=t.blocks[F];break}if(C){S=x,B=r.getActiveUniformBlockParameter(t.glProgram,S,r.UNIFORM_BLOCK_DATA_SIZE);var P=C.binding+(e.bindingMappingInfo.bufferOffsets[C.set]||0);r.uniformBlockBinding(t.glProgram,S,P),t.glBlocks[x]={set:C.set,binding:C.binding,idx:S,name:T,size:B,glBinding:P}}else i("Block '"+T+"' does not bound")}}if(t.samplers.length>0){t.glSamplers=new Array(t.samplers.length);for(var I=0;I<t.samplers.length;++I){var G=t.samplers[I];t.glSamplers[I]={set:G.set,binding:G.binding,name:G.name,type:G.type,count:G.count,units:[],glUnits:null,glType:Te(G.type,r),glLoc:null}}}for(var O=[],v=[],D=e.bindingMappingInfo,L=e.stateCache.texUnitCacheMap,U=0,N=0;N<t.blocks.length;++N)t.blocks[N].set===D.flexibleSet&&U++;for(var y=0,w=0;w<t.samplers.length;++w){var k=t.samplers[w],V=r.getUniformLocation(t.glProgram,k.name);if(V&&(O.push(t.glSamplers[w]),v.push(V)),void 0===L[k.name]){var W=k.binding+D.samplerOffsets[k.set]+y;k.set===D.flexibleSet&&(W-=U),L[k.name]=W%e.maxTextureUnits,y+=k.count-1}}if(O.length){for(var H=[],X=0;X<O.length;++X){var z=O[X],K=L[z.name];if(void 0!==K){z.glLoc=v[X];for(var Y=0;Y<z.count;++Y){for(;H[K];)K=(K+1)%e.maxTextureUnits;z.units.push(K),H[K]=!0}}}for(var q=0,Z=0;Z<O.length;++Z){var j=O[Z];if(!j.glLoc){for(j.glLoc=v[Z];H[q];)q++;for(var Q=0;Q<j.count;++Q){for(;H[q];)q=(q+1)%e.maxTextureUnits;void 0===L[j.name]&&(L[j.name]=q),j.units.push(q),H[q]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var J=0;J<O.length;J++){var $=O[J];$.glUnits=new Int32Array($.units),r.uniform1iv($.glLoc,$.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}t.glSamplers=O}}(this._device,this._gpuShader),!0},a.destroy=function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},r(s,[{key:"gpuShader",get:function(){return this._gpuShader}}]),s}(q),ut=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new L,this.scissorRect=new g(0,0,0,0),this.rs=new Z,this.dss=new j,this.bs=new Q,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var s=0;s<e;++s)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=r,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=r,this.glCurrentAttribLocs.fill(!1)},e}(),lt=function(e){function i(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t}t(i,e);var a=i.prototype;return a.initialize=function(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=J(this._width)&&J(this._height),this._size=$(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&I.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var r=e.gl;t.glInternalFmt=Ee(t.format,r),t.glFormat=pe(t.format,r),t.glType=Ae(t.format,r);var i=t.width,a=t.height;switch(t.type){case p.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(i,a);if(n>e.maxTextureSize&&s(9100,n,e.maxTextureSize),t.samples===B.X1){var u=r.createTexture();if(u&&t.size>0){t.glTexture=u;var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),T[t.format].isCompressed)if(t.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<t.mipLevel;++_){var c=S(t.format,i,a,1),o=new Uint8Array(c);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,i,a,0,o),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}else{var f=S(t.format,2,2,1),h=new Uint8Array(f);r.compressedTexImage2D(r.TEXTURE_2D,0,t.glInternalFmt,2,2,0,h)}else for(var d=0;d<t.mipLevel;++d)r.texImage2D(r.TEXTURE_2D,d,t.glInternalFmt,i,a,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}else r.deleteTexture(u)}else{var g=r.createRenderbuffer();g&&t.size>0&&(t.glRenderbuffer=g,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,ge[t.samples],t.glInternalFmt,t.width,t.height))}break;case p.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var R=Math.max(i,a);R>e.maxCubeMapTextureSize&&s(9100,R,e.maxTextureSize);var A=r.createTexture();if(A&&t.size>0){t.glTexture=A;var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),T[t.format].isCompressed)if(t.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL)for(var C=0;C<6;++C){i=t.width,a=t.height;for(var m=0;m<t.mipLevel;++m){var x=S(t.format,i,a,1),b=new Uint8Array(x);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+C,m,t.glInternalFmt,i,a,0,b),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}}else for(var F=0;F<6;++F){var P=S(t.format,2,2,1),I=new Uint8Array(P);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+F,0,t.glInternalFmt,2,2,0,I)}else for(var G=0;G<6;++G){i=t.width,a=t.height;for(var M=0;M<t.mipLevel;++M)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+G,M,t.glInternalFmt,i,a,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=p.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)},a.destroy=function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null},a.resize=function(e,t){var r=this._size;this._width=e,this._height=t,this._size=$(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var r=e.gl;t.glInternalFmt=Ee(t.format,r),t.glFormat=pe(t.format,r),t.glType=Ae(t.format,r);var i=t.width,a=t.height;switch(t.type){case p.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(i,a);if(n>e.maxTextureSize&&s(9100,n,e.maxTextureSize),t.samples===B.X1){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),T[t.format].isCompressed){if(t.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var _=S(t.format,i,a,1),c=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,i,a,0,c),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}}else for(var o=0;o<t.mipLevel;++o)r.texImage2D(r.TEXTURE_2D,o,t.glInternalFmt,i,a,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}else{var f=r.createRenderbuffer();f&&t.size>0&&(t.glRenderbuffer=f,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,ge[t.samples],t.glInternalFmt,t.width,t.height))}break;case p.CUBE:t.type=p.CUBE,t.glTarget=r.TEXTURE_CUBE_MAP;var h=Math.max(i,a);h>e.maxCubeMapTextureSize&&s(9100,h,e.maxTextureSize);var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),d.glTexture=t.glTexture),T[t.format].isCompressed){if(t.glInternalFmt!==fe.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){i=t.width,a=t.height;for(var R=0;R<t.mipLevel;++R){var A=S(t.format,i,a,1),E=new Uint8Array(A);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+g,R,t.glInternalFmt,i,a,0,E),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}}}else for(var C=0;C<6;++C){i=t.width,a=t.height;for(var m=0;m<t.mipLevel;++m)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+C,m,t.glInternalFmt,i,a,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),a=Math.max(1,a>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=p.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=r,this._device.memoryStatus.textureSize+=this._size)},r(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),i}(ee),_t=e("WebGL2Device",function(e){function s(){for(var t,r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new ut,t.cmdAllocator=new Ke,t.nullTex2D=null,t.nullTexCube=null,t._webGL2RC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!0,t._bindingMappingInfo=new ce,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._OES_texture_float_linear=null,t._OES_texture_half_float_linear=null,t._EXT_color_buffer_float=null,t._EXT_disjoint_timer_query_webgl2=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_renderer_info=null,t._WEBGL_texture_storage_multisample=null,t._WEBGL_debug_shaders=null,t._WEBGL_lose_context=null,t}t(s,e);var i=s.prototype;return i.initialize=function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:n.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=te.WEBGL2,this._deviceName="WebGL2";var r=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR)),this._version=r.getParameter(r.VERSION),this._maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=r.getParameter(r.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=r.getParameter(r.MAX_UNIFORM_BLOCK_SIZE),this._maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._uboOffsetAlignment=r.getParameter(r.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._depthBits=r.getParameter(r.DEPTH_BITS),this._stencilBits=r.getParameter(r.STENCIL_BITS),this.stateCache.initialize(this._maxTextureUnits,this._maxUniformBufferBindings,this._maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=d.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=d.D32F_S8:this._depthStencilFmt=d.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=d.D24S8:this._depthStencilFmt=d.D24:8===this._stencilBits?this._depthStencilFmt=d.D16S8:this._depthStencilFmt=d.D16,this._extensions=r.getSupportedExtensions();var s="";if(this._extensions){for(var i,a=u(this._extensions);!(i=a()).done;)s+=i.value+" ";console.debug("EXTENSIONS: "+s)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[re.TEXTURE_FLOAT]=!0,this._features[re.TEXTURE_HALF_FLOAT]=!0,this._features[re.FORMAT_R11G11B10F]=!0,this._features[re.FORMAT_RGB8]=!0,this._features[re.FORMAT_D16]=!0,this._features[re.FORMAT_D24]=!0,this._features[re.FORMAT_D32F]=!0,this._features[re.FORMAT_D24S8]=!0,this._features[re.FORMAT_D32FS8]=!0,this._features[re.MSAA]=!0,this._features[re.ELEMENT_INDEX_UINT]=!0,this._features[re.INSTANCED_ARRAYS]=!0,this._features[re.MULTIPLE_RENDER_TARGETS]=!0,this._features[re.BLEND_MINMAX]=!0,this._EXT_color_buffer_float&&(this._features[re.COLOR_FLOAT]=!0,this._features[re.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[re.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[re.TEXTURE_HALF_FLOAT_LINEAR]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[re.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[re.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[re.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[re.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[re.FORMAT_ASTC]=!0,l+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_ATTRIBS: "+this._maxVertexAttributes),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_FRAGMENT_UNIFORM_VECTORS: "+this._maxFragmentUniformVectors),console.info("MAX_TEXTURE_IMAGE_UNITS: "+this._maxTextureUnits),console.info("MAX_VERTEX_TEXTURE_IMAGE_UNITS: "+this._maxVertexTextureUnits),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("MAX_UNIFORM_BLOCK_SIZE: "+this._maxUniformBlockSize),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),console.info("UNIFORM_BUFFER_OFFSET_ALIGNMENT: "+this._uboOffsetAlignment),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(r),this._queue=this.createQueue(new se(ie.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ae(this._queue)),this.nullTex2D=this.createTexture(new ne(p.TEX2D,ue.SAMPLED,d.RGBA8,2,2,I.GEN_MIPMAP)),this.nullTexCube=new lt(this),this.nullTexCube.initialize(new ne(p.TEX2D,ue.SAMPLED,d.RGBA8,2,2,I.CUBEMAP|I.GEN_MIPMAP,6));var _=new le;_.texExtent.width=2,_.texExtent.height=2;var c=new Uint8Array(this.nullTex2D.size);return c.fill(0),this.copyBuffersToTexture([c],this.nullTex2D,[_]),_.texSubres.layerCount=6,this.copyBuffersToTexture([c,c,c,c,c,c],this.nullTexCube,[_]),!0},i.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGL2RC=null},i.resize=function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)},i.acquire=function(){this.cmdAllocator.releaseCmds()},i.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},i.createCommandBuffer=function(e){var t=new(e.type===U.PRIMARY?rt:Ye)(this);return t.initialize(e)?t:null},i.createBuffer=function(e){var t=new Xe(this);return t.initialize(e)?t:null},i.createTexture=function(e){var t=new lt(this);return t.initialize(e)?t:null},i.createSampler=function(e){var t=new at(this);return t.initialize(e)?t:null},i.createDescriptorSet=function(e){var t=new he(this);return t.initialize(e)?t:null},i.createShader=function(e){var t=new nt(this);return t.initialize(e)?t:null},i.createInputAssembler=function(e){var t=new je(this);return t.initialize(e)?t:null},i.createRenderPass=function(e){var t=new it(this);return t.initialize(e)?t:null},i.createFramebuffer=function(e){var t=new Ze(this);return t.initialize(e)?t:null},i.createDescriptorSetLayout=function(e){var t=new Qe(this);return t.initialize(e)?t:null},i.createPipelineLayout=function(e){var t=new Je(this);return t.initialize(e)?t:null},i.createPipelineState=function(e){var t=new et(this);return t.initialize(e)?t:null},i.createFence=function(e){var t=new qe(this);return t.initialize(e)?t:null},i.createQueue=function(e){var t=new st(this);return t.initialize(e)?t:null},i.copyBuffersToTexture=function(e,t,r){He(this,e,t.gpuTexture,r)},i.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var i=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==r.glTexture&&(i.bindTexture(r.glTarget,r.glTexture),a.glTexture=r.glTexture);var n=0,u=0;switch(r.glTarget){case i.TEXTURE_2D:for(var l=0;l<s.length;l++){var _=s[l];i.texSubImage2D(i.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[n++])}break;case i.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var o=s[c],f=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(u=o.texSubres.baseArrayLayer;u<f;++u)i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+u,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&I.GEN_MIPMAP&&i.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},i.copyFramebufferToBuffer=function(e,t,r){var s=this._webGL2RC,i=e.gpuFramebuffer,a=i.gpuColorTextures[0].format,n=pe(a,s),l=Ae(a,s),_=_e(T[a]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==i.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,i.glFramebuffer),this.stateCache.glFramebuffer=i.glFramebuffer);for(var o,f=new _(t),h=u(r);!(o=h()).done;){var d=o.value,g=d.texExtent.width,R=d.texExtent.height;s.readPixels(d.texOffset.x,d.texOffset.y,g,R,n,l,f)}this.stateCache.glFramebuffer!==c&&(s.bindFramebuffer(s.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)},i.blitFramebuffer=function(e,t,r,s,i){!function(e,t,r,s,i,a){var n=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(n.bindFramebuffer(n.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var u=r.glFramebuffer!==e.stateCache.glFramebuffer;u&&n.bindFramebuffer(n.DRAW_FRAMEBUFFER,r.glFramebuffer);var l=0;t.gpuColorTextures.length>0&&(l|=n.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(l|=n.DEPTH_BUFFER_BIT,T[t.gpuDepthStencilTexture.format].hasStencil&&(l|=n.STENCIL_BUFFER_BIT));var _=a===C.LINEAR||a===C.ANISOTROPIC?n.LINEAR:n.NEAREST;n.blitFramebuffer(s.x,s.y,s.x+s.width,s.y+s.height,i.x,i.y,i.x+i.width,i.y+i.height,l,_),u&&n.bindFramebuffer(n.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,r,s,i)},i.getExtension=function(e){for(var t=["","WEBKIT_","MOZ_"],r=0;r<t.length;++r){var s=this.gl.getExtension(t[r]+e);if(s)return s}return null},i.initStates=function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)},i._onWebGLContextLost=function(e){l(11e3),_(e)},r(s,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_texture_storage_multisample",get:function(){return this._WEBGL_texture_storage_multisample}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}}]),s}(oe));c.WebGL2Device=_t}}}));
