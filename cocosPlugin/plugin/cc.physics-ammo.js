System.register(["./deprecated-0768b3d4.js","./deprecated-4df5f565.js","./audio-downloader-f2f97571.js","./index-0614c00d.js","./deprecated-88eb2353.js","./screen-f991c158.js","./_commonjsHelpers-f10ca08b.js","./collision-matrix-a4920c2a.js","./ammo-instantiated-37d8f206.js","./index-96a0e053.js","./terrain-asset-62469b77.js","./array-collision-matrix-ec6af177.js"],(function(){"use strict";var t,i,e,s,o,n,r,a,h,l,d,c,p,u,_,S;return{setters:[function(l){t=l.a,i=l.V,e=l.a0,s=l._,o=l.au,n=l.y,r=l.w,a=l.aC,h=l.aB},function(t){l=t.P,d=t.d$},function(){},function(){},function(){},function(){},function(){},function(t){c=t.E},function(t){p=t.A},function(t){u=t.P,_=t.s},function(){},function(t){S=t.A}],execute:function(){function y(t,i){return t.setValue(i.x,i.y,i.z),t}function f(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t}function g(t,i){return t.setValue(i.x,i.y,i.z,i.w),t}function C(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t.w=i.w(),t}function E(t,i){delete i.__cache__[t.ptr]}function m(t,i){for(var e=i.renderingSubMeshes.length,s=0;s<e;s++){var o=i.renderingSubMeshes[s],n=o.geometricInfo;if(n){var r=o.primitiveMode,a=n.positions,h=n.indices;if(r==l.TRIANGLE_LIST)for(var d=h.length,c=0;c<d;c+=3){var u=3*h[c],_=3*h[c+1],S=3*h[c+2],y=new p.btVector3(a[u],a[u+1],a[u+2]),f=new p.btVector3(a[_],a[_+1],a[_+2]),g=new p.btVector3(a[S],a[S+1],a[S+2]);t.addTriangle(y,f,g),p.destroy(y),p.destroy(f),p.destroy(g)}else if(r==l.TRIANGLE_STRIP)for(var C=h.length-2,E=0,m=0;m<C;m+=1){var T=3*h[m-E],A=3*h[m+E+1],b=3*h[m+2];E=~E;var O=new p.btVector3(a[T],a[T+1],a[T+2]),P=new p.btVector3(a[A],a[A+1],a[A+2]),B=new p.btVector3(a[b],a[b+1],a[b+2]);t.addTriangle(O,P,B),p.destroy(O),p.destroy(P),p.destroy(B)}else if(r==l.TRIANGLE_FAN)for(var v=h.length-1,I=3*h[0],R=new p.btVector3(a[I],a[I+1],a[I+2]),w=1;w<v;w+=1){var D=3*h[w],Y=3*h[w+1],H=new p.btVector3(a[D],a[D+1],a[D+2]),L=new p.btVector3(a[Y],a[Y+1],a[Y+2]);t.addTriangle(R,H,L),p.destroy(R),p.destroy(H),p.destroy(L)}}}return t}var T,A,b,O,P,B,v,I,R;!function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(T||(T={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(A||(A={})),p.AmmoCollisionFlags=A,function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(b||(b={})),p.AmmoCollisionObjectTypes=b,function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(O||(O={})),function(t){t[t.CF_ANISOTROPIC_FRICTION_DISABLED=0]="CF_ANISOTROPIC_FRICTION_DISABLED",t[t.CF_ANISOTROPIC_FRICTION=1]="CF_ANISOTROPIC_FRICTION",t[t.CF_ANISOTROPIC_ROLLING_FRICTION=2]="CF_ANISOTROPIC_ROLLING_FRICTION"}(P||(P={})),p.AmmoAnisotropicFrictionFlags=P,function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(B||(B={})),p.AmmoRigidBodyFlags=B,function(t){t[t.BOX_SHAPE_PROXYTYPE=0]="BOX_SHAPE_PROXYTYPE",t[t.TRIANGLE_SHAPE_PROXYTYPE=1]="TRIANGLE_SHAPE_PROXYTYPE",t[t.TETRAHEDRAL_SHAPE_PROXYTYPE=2]="TETRAHEDRAL_SHAPE_PROXYTYPE",t[t.CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE=3]="CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE",t[t.CONVEX_HULL_SHAPE_PROXYTYPE=4]="CONVEX_HULL_SHAPE_PROXYTYPE",t[t.CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE=5]="CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE",t[t.CUSTOM_POLYHEDRAL_SHAPE_TYPE=6]="CUSTOM_POLYHEDRAL_SHAPE_TYPE",t[t.IMPLICIT_CONVEX_SHAPES_START_HERE=7]="IMPLICIT_CONVEX_SHAPES_START_HERE",t[t.SPHERE_SHAPE_PROXYTYPE=8]="SPHERE_SHAPE_PROXYTYPE",t[t.MULTI_SPHERE_SHAPE_PROXYTYPE=9]="MULTI_SPHERE_SHAPE_PROXYTYPE",t[t.CAPSULE_SHAPE_PROXYTYPE=10]="CAPSULE_SHAPE_PROXYTYPE",t[t.CONE_SHAPE_PROXYTYPE=11]="CONE_SHAPE_PROXYTYPE",t[t.CONVEX_SHAPE_PROXYTYPE=12]="CONVEX_SHAPE_PROXYTYPE",t[t.CYLINDER_SHAPE_PROXYTYPE=13]="CYLINDER_SHAPE_PROXYTYPE",t[t.UNIFORM_SCALING_SHAPE_PROXYTYPE=14]="UNIFORM_SCALING_SHAPE_PROXYTYPE",t[t.MINKOWSKI_SUM_SHAPE_PROXYTYPE=15]="MINKOWSKI_SUM_SHAPE_PROXYTYPE",t[t.MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE=16]="MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE",t[t.BOX_2D_SHAPE_PROXYTYPE=17]="BOX_2D_SHAPE_PROXYTYPE",t[t.CONVEX_2D_SHAPE_PROXYTYPE=18]="CONVEX_2D_SHAPE_PROXYTYPE",t[t.CUSTOM_CONVEX_SHAPE_TYPE=19]="CUSTOM_CONVEX_SHAPE_TYPE",t[t.CONCAVE_SHAPES_START_HERE=20]="CONCAVE_SHAPES_START_HERE",t[t.TRIANGLE_MESH_SHAPE_PROXYTYPE=21]="TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE=22]="SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.FAST_CONCAVE_MESH_PROXYTYPE=23]="FAST_CONCAVE_MESH_PROXYTYPE",t[t.TERRAIN_SHAPE_PROXYTYPE=24]="TERRAIN_SHAPE_PROXYTYPE",t[t.GIMPACT_SHAPE_PROXYTYPE=25]="GIMPACT_SHAPE_PROXYTYPE",t[t.MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE=26]="MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE",t[t.EMPTY_SHAPE_PROXYTYPE=27]="EMPTY_SHAPE_PROXYTYPE",t[t.STATIC_PLANE_PROXYTYPE=28]="STATIC_PLANE_PROXYTYPE",t[t.CUSTOM_CONCAVE_SHAPE_TYPE=29]="CUSTOM_CONCAVE_SHAPE_TYPE",t[t.CONCAVE_SHAPES_END_HERE=30]="CONCAVE_SHAPES_END_HERE",t[t.COMPOUND_SHAPE_PROXYTYPE=31]="COMPOUND_SHAPE_PROXYTYPE",t[t.SOFTBODY_SHAPE_PROXYTYPE=32]="SOFTBODY_SHAPE_PROXYTYPE",t[t.HFFLUID_SHAPE_PROXYTYPE=33]="HFFLUID_SHAPE_PROXYTYPE",t[t.HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE=34]="HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE",t[t.INVALID_SHAPE_PROXYTYPE=35]="INVALID_SHAPE_PROXYTYPE",t[t.MAX_BROADPHASE_COLLISION_TYPES=36]="MAX_BROADPHASE_COLLISION_TYPES"}(v||(v={})),p.AmmoBroadphaseNativeTypes=v,function(t){t[t.DefaultFilter=1]="DefaultFilter",t[t.StaticFilter=2]="StaticFilter",t[t.KinematicFilter=4]="KinematicFilter",t[t.DebrisFilter=8]="DebrisFilter",t[t.SensorTrigger=16]="SensorTrigger",t[t.CharacterFilter=32]="CharacterFilter",t[t.AllFilter=-1]="AllFilter"}(I||(I={})),p.AmmoCollisionFilterGroups=I,function(t){t[t.CD_STATIC_STATIC_REPORTED=1]="CD_STATIC_STATIC_REPORTED",t[t.CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD=2]="CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD",t[t.CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION=4]="CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION"}(R||(R={})),p.AmmoDispatcherFlags=R;var w={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},D={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},Y=function(){function i(){this.EMPTY_SHAPE=new p.btEmptyShape,this.TRANSFORM=new p.btTransform,this.VECTOR3_0=new p.btVector3,this.VECTOR3_1=new p.btVector3,this.QUAT_0=new p.btQuaternion}return t(i,null,[{key:"instance",get:function(){return null==i._instance&&(i._instance=new i),i._instance}}]),i}();Y._instance=void 0;var H=new i,L=new i,N=new e,M=H,F=L,V=function(){var e=s.prototype;function s(){this.id=void 0,this._isEnabled=!1,this.id=s.idCounter++}return e.setMass=function(t){if(this._rigidBody.isDynamic){var i=Y.instance.VECTOR3_0;i.setValue(1.6666666269302368,1.6666666269302368,1.6666666269302368);var e=this.impl.getCollisionShape();e.isCompound()?this._sharedBody.bodyCompoundShape.getNumChildShapes()>0&&e.calculateLocalInertia(this._rigidBody.mass,i):e.calculateLocalInertia(this._rigidBody.mass,i),this.impl.setMassProps(t,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=T.BODY_RE_ADD}},e.setType=function(t){var i=this.impl.getCollisionFlags(),e=Y.instance.VECTOR3_0;switch(t){case c.DYNAMIC:i&=~A.CF_KINEMATIC_OBJECT,i&=~A.CF_STATIC_OBJECT,this.impl.setCollisionFlags(i),this.setMass(this._rigidBody.mass),this.useGravity(this._rigidBody.useGravity),this.setAllowSleep(this._rigidBody.allowSleep);break;case c.KINEMATIC:i|=A.CF_KINEMATIC_OBJECT,i&=~A.CF_STATIC_OBJECT,this.impl.setCollisionFlags(i),e.setValue(0,0,0),this.impl.setMassProps(0,e),this.impl.forceActivationState(O.DISABLE_DEACTIVATION);break;case c.STATIC:default:i|=A.CF_STATIC_OBJECT,i&=~A.CF_KINEMATIC_OBJECT,this.impl.setCollisionFlags(i),e.setValue(0,0,0),this.impl.setMassProps(0,e),this.impl.forceActivationState(O.DISABLE_DEACTIVATION)}},e.setLinearDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},e.setAngularDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},e.useGravity=function(t){if(this._rigidBody.isDynamic){var e=this.impl.getFlags();t?e&=~B.BT_DISABLE_WORLD_GRAVITY:(this.impl.setGravity(y(Y.instance.VECTOR3_0,i.ZERO)),e|=B.BT_DISABLE_WORLD_GRAVITY),this.impl.setFlags(e),this._wakeUpIfSleep(),this._sharedBody.dirty|=T.BODY_RE_ADD}},e.setLinearFactor=function(t){this.impl.setLinearFactor(y(Y.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},e.setAngularFactor=function(t){this.impl.setAngularFactor(y(Y.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},e.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?this.impl.forceActivationState(O.ACTIVE_TAG):this.impl.forceActivationState(O.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},t(s,[{key:"isAwake",get:function(){var t=this.impl.getActivationState();return t==O.ACTIVE_TAG||t==O.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return this.impl.getActivationState()==O.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return this.impl.getActivationState()==O.ISLAND_SLEEPING}},{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}}]),e.clearState=function(){this.impl.clearState()},e.clearVelocity=function(){this.setLinearVelocity(i.ZERO),this.setAngularVelocity(i.ZERO)},e.clearForces=function(){this.impl.clearForces()},e.initialize=function(t){this._rigidBody=t,this._sharedBody=u.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},e.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setType(this._rigidBody.type),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},e.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},e.wakeUp=function(t){void 0===t&&(t=!0),this.impl.activate(t)},e.sleep=function(){return this.impl.wantsSleeping()},e.setSleepThreshold=function(t){this._wakeUpIfSleep(),this.impl.setSleepingThresholds(t,t)},e.getSleepThreshold=function(){return this.impl.getLinearSleepingThreshold()},e.getType=function(){return this.impl.isStaticOrKinematicObject()?this.impl.isKinematicObject()?c.KINEMATIC:c.STATIC:c.DYNAMIC},e.getLinearVelocity=function(t){return f(t,this.impl.getLinearVelocity())},e.setLinearVelocity=function(t){this._wakeUpIfSleep(),y(this.impl.getLinearVelocity(),t)},e.getAngularVelocity=function(t){return f(t,this.impl.getAngularVelocity())},e.setAngularVelocity=function(t){this._wakeUpIfSleep(),y(this.impl.getAngularVelocity(),t)},e.applyLocalForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=i.transformQuat(M,t,s),n=e?i.transformQuat(F,e,s):i.ZERO;this.impl.applyForce(y(Y.instance.VECTOR3_0,o),y(Y.instance.VECTOR3_1,n))},e.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),i.transformQuat(M,t,this._sharedBody.node.worldRotation),this.impl.applyTorque(y(Y.instance.VECTOR3_0,M))},e.applyLocalImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=i.transformQuat(M,t,s),n=e?i.transformQuat(F,e,s):i.ZERO;this.impl.applyImpulse(y(Y.instance.VECTOR3_0,o),y(Y.instance.VECTOR3_1,n))},e.applyForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||i.ZERO;this.impl.applyForce(y(Y.instance.VECTOR3_0,t),y(Y.instance.VECTOR3_1,s))},e.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),this.impl.applyTorque(y(Y.instance.VECTOR3_0,t))},e.applyImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||i.ZERO;this.impl.applyImpulse(y(Y.instance.VECTOR3_0,t),y(Y.instance.VECTOR3_1,s))},e.getGroup=function(){return this._sharedBody.collisionFilterGroup},e.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},e.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},e.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},e.getMask=function(){return this._sharedBody.collisionFilterMask},e.setMask=function(t){this._sharedBody.collisionFilterMask=t},e.addMask=function(t){this._sharedBody.collisionFilterMask|=t},e.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},e._wakeUpIfSleep=function(){this.isAwake||this.impl.activate(!0)},s}();V.idCounter=0;var x=function(){function i(){}return t(i,null,[{key:"bodyStructs",get:function(){return this.bodyAndGhosts}},{key:"ghostStructs",get:function(){return this.bodyAndGhosts}}]),i}();x.bodyAndGhosts={};var G=H,k=N,X=0,U=function(){function i(t,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.dirty=0,this._collisionFilterGroup=u.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._wrappedBody=null,this.id=i.idCounter++,this.wrappedWorld=e,this.node=t}i.getSharedBody=function(t,e,s){var o,n=t.uuid;if(i.sharedBodesMap.has(n)?o=i.sharedBodesMap.get(n):(o=new i(t,e),i.sharedBodesMap.set(t.uuid,o)),s){o._wrappedBody=s;var r=s.rigidBody.group,a=u.instance.collisionMatrix[r];o._collisionFilterGroup=r,o._collisionFilterMask=a}return o},t(i,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.shape}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.shape}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!=this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=T.BODY_RE_ADD,this.dirty|=T.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!=this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=T.BODY_RE_ADD,this.dirty|=T.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){t?this.bodyIndex<0&&(this.bodyIndex=this.wrappedWorld.bodies.length,this.body.clearState(),this.wrappedWorld.addSharedBody(this),this.syncInitialBody()):this.bodyIndex>=0&&(0==this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0==this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0==this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(this.body.clearState(),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0==this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0==this.ref&&this.destroy()}}]);var e=i.prototype;return e._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=new p.btTransform;t.setIdentity(),y(t.getOrigin(),this.node.worldPosition);var i=new p.btQuaternion;g(i,this.node.worldRotation),t.setRotation(i);var e=new p.btDefaultMotionState(t),s=new p.btVector3(1.6666666269302368,1.6666666269302368,1.6666666269302368),o=new p.btCompoundShape,n=0;this._wrappedBody&&this._wrappedBody.rigidBody.isDynamic&&(n=this._wrappedBody.rigidBody.mass),0==n&&s.setValue(0,0,0);var r=new p.btRigidBodyConstructionInfo(n,e,Y.instance.EMPTY_SHAPE,s),a=new p.btRigidBody(r),h=u.instance.sleepThreshold;a.setSleepingThresholds(h,h),this._bodyStruct={id:X++,body:a,localInertia:s,motionState:e,startTransform:t,shape:o,rbInfo:r,worldQuat:i,wrappedShapes:[],useCompound:!1},x.bodyStructs["KEY"+this._bodyStruct.id]=this._bodyStruct,this.body.setUserIndex(this._bodyStruct.id),0==n&&this.body.setActivationState(O.DISABLE_DEACTIVATION),p.CC_CONFIG.ignoreSelfBody&&this._ghostStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}},e._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=new p.btCollisionObject,i=new p.btCompoundShape;t.setCollisionShape(i),t.setCollisionFlags(A.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:X++,ghost:t,shape:i,worldQuat:new p.btQuaternion,wrappedShapes:[]},x.ghostStructs["KEY"+this._ghostStruct.id]=this._ghostStruct,this.ghost.setUserIndex(this._ghostStruct.id),this.ghost.setActivationState(O.DISABLE_DEACTIVATION),p.CC_CONFIG.ignoreSelfBody&&this._bodyStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}},e.addShape=function(t,i){function e(t,i){t.body.setCollisionShape(i),t.dirty|=T.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!=s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var o=0;o<s;o++)this.bodyStruct.wrappedShapes[o].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.shape)}else e(this,t.impl)}this.bodyEnabled=!0}},e.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(this.ghostStruct.wrappedShapes.splice(e,1),t.setCompound(null),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(null):this.body.setCollisionShape(Y.instance.EMPTY_SHAPE),this.body.activate(!0),this.dirty|=T.BODY_RE_ADD,this.bodyStruct.wrappedShapes.splice(s,1),this.bodyEnabled=!1)}},e.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&T.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&T.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},e.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=this.body.getWorldTransform();if(y(t.getOrigin(),this.node.worldPosition),g(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.node.hasChangedFlags&d.SCALE)for(var i=0;i<this.bodyStruct.wrappedShapes.length;i++)this.bodyStruct.wrappedShapes[i].setScale();if(this.body.isKinematicObject()){var e=this.body.getMotionState();e&&e.setWorldTransform(t)}else this.isBodySleeping()&&this.body.activate()}},e.syncPhysicsToScene=function(){if(!this.body.isStaticOrKinematicObject()&&!this.isBodySleeping()){var t=this.bodyStruct.startTransform;this.body.getMotionState().getWorldTransform(t),this.node.worldPosition=f(G,t.getOrigin()),t.getBasis().getRotation(this.bodyStruct.worldQuat),this.node.worldRotation=C(k,this.bodyStruct.worldQuat);var i=this.ghost.getWorldTransform();y(i.getOrigin(),this.node.worldPosition),g(this.ghostStruct.worldQuat,this.node.worldRotation),i.setRotation(this.ghostStruct.worldQuat)}},e.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=this.ghost.getWorldTransform();if(y(t.getOrigin(),this.node.worldPosition),g(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.ghost.activate(),this.node.hasChangedFlags&d.SCALE)for(var i=0;i<this.ghostStruct.wrappedShapes.length;i++)this.ghostStruct.wrappedShapes[i].setScale()}},e.syncInitialBody=function(){var t=this.body.getWorldTransform();y(t.getOrigin(),this.node.worldPosition),g(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat);for(var i=0;i<this.bodyStruct.wrappedShapes.length;i++)this.bodyStruct.wrappedShapes[i].setScale();this.body.activate()},e.syncInitialGhost=function(){var t=this.ghost.getWorldTransform();y(t.getOrigin(),this.node.worldPosition),g(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat);for(var i=0;i<this.ghostStruct.wrappedShapes.length;i++)this.ghostStruct.wrappedShapes[i].setScale();this.ghost.activate()},e.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},e.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},e.destroy=function(){if(i.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var t=this._bodyStruct;p.destroy(t.localInertia),p.destroy(t.worldQuat),p.destroy(t.startTransform),p.destroy(t.motionState),p.destroy(t.rbInfo),p.destroy(t.shape),E(t.shape,p.btCollisionShape),p.castObject(t.body,p.btRigidBody).wrapped=null,E(t.body,p.btRigidBody),E(t.body,p.btCollisionObject);var e="KEY"+t.id;delete x.bodyStructs[e],this._bodyStruct=null}if(this._ghostStruct){var s=this._ghostStruct;p.destroy(s.worldQuat),p.destroy(s.shape),E(s.shape,p.btCollisionShape),p.destroy(s.ghost);var o="KEY"+s.id;delete x.bodyStructs[o],this._ghostStruct=null}},e.isBodySleeping=function(){return this.body.getActivationState()==O.ISLAND_SLEEPING},i}();U.idCounter=0,U.sharedBodesMap=new Map;var W=function(){function t(){this.data=void 0,this.data={keys:[]}}var i=t.prototype;return i.get=function(t,i){if(t>i){var e=i;i=t,t=e}return this.data[t+"-"+i]},i.set=function(t,i,e){if(t>i){var s=i;i=t,t=s}var o=t+"-"+i;if(null==e){var n=this.data.keys.indexOf(o);if(-1!=n)return this.data.keys.splice(n,1),delete this.data[o],e}return this.get(t,i)||this.data.keys.push(o),this.data[o]=e,this.data[o]},i.reset=function(){for(var t=this.data,i=t.keys;i.length>0;)delete t[i.pop()]},i.getLength=function(){return this.data.keys.length},i.getKeyByIndex=function(t){return this.data.keys[t]},i.getDataByKey=function(t){return this.data[t]},t}(),j=function(){function s(t){this.impl=null,this.event=void 0,this.event=t}t(s,[{key:"isBodyA",get:function(){var t=this.event.selfCollider.shape.sharedBody.body,i=this.event.impl.getBody0();return Ammo.compare(i,t)}}]);var o=s.prototype;return o.getLocalPointOnA=function(t){this.impl&&f(t,this.impl.m_localPointA)},o.getLocalPointOnB=function(t){this.impl&&f(t,this.impl.m_localPointB)},o.getWorldPointOnA=function(t){this.impl&&f(t,this.impl.m_positionWorldOnA)},o.getWorldPointOnB=function(t){this.impl&&f(t,this.impl.m_positionWorldOnB)},o.getLocalNormalOnB=function(t){if(this.impl){var s=N,o=Y.instance.QUAT_0;this.event.impl.getBody1().getWorldTransform().getBasis().getRotation(o),C(s,o),e.invert(s,s),f(t,this.impl.m_normalWorldOnB),i.transformQuat(t,t,s)}},o.getWorldNormalOnB=function(t){this.impl&&f(t,this.impl.m_normalWorldOnB)},s}(),K=[],z=H,Q=L,J=function(){var e=s.prototype;function s(){this._btWorld=void 0,this._btBroadphase=void 0,this._btSolver=void 0,this._btDispatcher=void 0,this._btGravity=void 0,this.bodies=[],this.ghosts=[],this.constraints=[],this.triggerArrayMat=new S,this.collisionArrayMat=new S,this.contactsDic=new W,this.oldContactsDic=new W,this.closeHitCB=new p.ClosestRayResultCallback(new p.btVector3,new p.btVector3),this.allHitsCB=new p.AllHitsRayResultCallback(new p.btVector3,new p.btVector3);var t=new p.btDefaultCollisionConfiguration;this._btDispatcher=new p.btCollisionDispatcher(t),this._btBroadphase=new p.btDbvtBroadphase,this._btSolver=new p.btSequentialImpulseConstraintSolver,this._btWorld=new p.btDiscreteDynamicsWorld(this._btDispatcher,this._btBroadphase,this._btSolver,t),this._btGravity=new p.btVector3(0,-10,0),this._btWorld.setGravity(this._btGravity)}return e.setAllowSleep=function(){},e.setDefaultMaterial=function(){},e.setGravity=function(t){y(this._btGravity,t),this._btWorld.setGravity(this._btGravity)},t(s,[{key:"impl",get:function(){return this._btWorld}}]),e.step=function(t,i,e){if(void 0===e&&(e=0),0!=this.bodies.length||0!=this.ghosts.length){null==i&&(i=t),this._btWorld.stepSimulation(i,e,t);for(var s=0;s<this.bodies.length;s++)this.bodies[s].syncPhysicsToScene()}},e.syncSceneToPhysics=function(){for(var t=0;t<this.ghosts.length;t++)this.ghosts[t].updateDirty(),this.ghosts[t].syncSceneToGhost();for(var i=0;i<this.bodies.length;i++)this.bodies[i].updateDirty(),this.bodies[i].syncSceneToPhysics()},e.raycast=function(t,e,s,o){var n=y(this.allHitsCB.m_rayFromWorld,t.o);t.computeHit(z,e.maxDistance);var r=y(this.allHitsCB.m_rayToWorld,z);this.allHitsCB.m_collisionFilterGroup=-1,this.allHitsCB.m_collisionFilterMask=e.mask,this.allHitsCB.m_closestHitFraction=1,this.allHitsCB.m_shapePart=-1,this.allHitsCB.m_collisionObject=null,this.allHitsCB.m_shapeParts.clear(),this.allHitsCB.m_hitFractions.clear(),this.allHitsCB.m_collisionObjects.clear();var a=this.allHitsCB.m_hitPointWorld,h=this.allHitsCB.m_hitNormalWorld;if(a.clear(),h.clear(),this._btWorld.rayTest(n,r,this.allHitsCB),this.allHitsCB.hasHit()){for(var l=0,d=this.allHitsCB.m_collisionObjects.size();l<d;l++){var c=this.allHitsCB.m_collisionObjects.at(l),p=c.getCollisionShape(),u=void 0;if(p.isCompound()){var _=this.allHitsCB.m_shapeParts.at(l),S=c.getUserIndex();u=x.bodyAndGhosts["KEY"+S].wrappedShapes[_]}else u=p.wrapped;f(z,a.at(l)),f(Q,h.at(l));var g=i.distance(t.o,z),C=s.add();C._assign(z,g,u.collider,Q),o.push(C)}return!0}return!1},e.raycastClosest=function(t,e,s){var o=y(this.closeHitCB.m_rayFromWorld,t.o);t.computeHit(z,e.maxDistance);var n=y(this.closeHitCB.m_rayToWorld,z);if(this.closeHitCB.m_collisionFilterGroup=-1,this.closeHitCB.m_collisionFilterMask=e.mask,this.closeHitCB.m_closestHitFraction=1,this.closeHitCB.m_collisionObject=null,this._btWorld.rayTest(o,n,this.closeHitCB),this.closeHitCB.hasHit()){var r,a=this.closeHitCB.m_collisionObject,h=a.getCollisionShape();if(h.isCompound()){var l=a.getUserIndex(),d=x.bodyAndGhosts["KEY"+l],c=this.closeHitCB.m_shapePart;r=d.wrappedShapes[c]}else r=h.wrapped;f(z,this.closeHitCB.m_hitPointWorld),f(Q,this.closeHitCB.m_hitNormalWorld);var p=i.distance(t.o,z);return s._assign(z,p,r.collider,Q),!0}return!1},e.getSharedBody=function(t,i){return U.getSharedBody(t,this,i)},e.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._btWorld.addRigidBody(t.body,t.collisionFilterGroup,t.collisionFilterMask))},e.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(this.bodies.splice(i,1),this._btWorld.removeRigidBody(t.body))},e.addGhostObject=function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),this._btWorld.addCollisionObject(t.ghost,t.collisionFilterGroup,t.collisionFilterMask))},e.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(this.ghosts.splice(i,1),this._btWorld.removeCollisionObject(t.ghost))},e.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),this._btWorld.addConstraint(t.impl,!t.constraint.enableCollision),t.index=i)},e.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),this._btWorld.removeConstraint(t.impl),t.index=-1)},e.updateCollisionMatrix=function(t,i){for(var e=0;e<this.ghosts.length;e++){var s=this.ghosts[e];s.collisionFilterGroup==t&&(s.collisionFilterMask=i)}for(var o=0;o<this.bodies.length;o++){var n=this.bodies[o];n.collisionFilterGroup==t&&(n.collisionFilterMask=i)}},e.emitEvents=function(){for(var t=this._btDispatcher.getNumManifolds(),i=0;i<t;i++){var e=this._btDispatcher.getManifoldByIndexInternal(i),s=e.getBody0(),o=e.getBody1();if((p.CC_CONFIG.emitStaticCollision||!s.isStaticObject()||!o.isStaticObject())&&!s.useCharacter&&!o.useCharacter)for(var n=s.useCCD||o.useCCD,r=e.getNumContacts(),a=0;a<r;a++){var h=e.getContactPoint(a);if(h.getDistance()<=0){var l=h.getShape0(),d=h.getShape1(),c=void 0,u=void 0;if(n){if(s.useCCD){var _=s.wrapped.sharedBody;if(!_)continue;c=_.bodyStruct.wrappedShapes[0]}else{var S=s.getCollisionShape();if(S.isCompound())continue;c=S.wrapped}if(o.useCCD){var y=o.wrapped.sharedBody;if(!y)continue;u=y.bodyStruct.wrappedShapes[0]}else{var f=o.getCollisionShape();if(f.isCompound())continue;u=f.wrapped}}else c=l.isCompound()?p.castObject(l,p.btCompoundShape).getChildShape(h.m_index0).wrapped:l.wrapped,u=d.isCompound()?p.castObject(d,p.btCompoundShape).getChildShape(h.m_index1).wrapped:d.wrapped;if(c.collider.needTriggerEvent||u.collider.needTriggerEvent||c.collider.needCollisionEvent||u.collider.needCollisionEvent){var g=this.contactsDic.get(c.id,u.id);null==g&&(g=this.contactsDic.set(c.id,u.id,{shape0:c,shape1:u,contacts:[],impl:e})),g.contacts.push(h)}}}}for(var C=this.contactsDic.getLength();C--;){K.push.apply(K,D.contacts),D.contacts.length=0;var E=this.contactsDic.getKeyByIndex(C),m=this.contactsDic.getDataByKey(E),T=m.shape0,A=m.shape1;this.oldContactsDic.set(T.id,A.id,m);var b=T.collider,O=A.collider;if(b&&O){if(b.isTrigger||O.isTrigger)this.triggerArrayMat.get(T.id,A.id)?w.type="onTriggerStay":(w.type="onTriggerEnter",this.triggerArrayMat.set(T.id,A.id,!0)),w.impl=m.impl,w.selfCollider=b,w.otherCollider=O,b.emit(w.type,w),w.selfCollider=O,w.otherCollider=b,O.emit(w.type,w);else{var P=b.attachedRigidBody,B=O.attachedRigidBody;if(P&&B){if(P.isSleeping&&B.isSleeping)continue}else if(null==P&&B){if(B.isSleeping)continue}else if(null==B&&P&&P.isSleeping)continue;this.collisionArrayMat.get(T.id,A.id)?D.type="onCollisionStay":(D.type="onCollisionEnter",this.collisionArrayMat.set(T.id,A.id,!0));for(var v=0;v<m.contacts.length;v++){var I=m.contacts[v];if(K.length>0){var R=K.pop();R.impl=I,D.contacts.push(R)}else{var Y=new j(D);Y.impl=I,D.contacts.push(Y)}}D.impl=m.impl,D.selfCollider=b,D.otherCollider=O,b.emit(D.type,D),D.selfCollider=O,D.otherCollider=b,O.emit(D.type,D)}null==this.oldContactsDic.get(T.id,A.id)&&this.oldContactsDic.set(T.id,A.id,m)}}for(var H=this.oldContactsDic.getLength();H--;){var L=this.oldContactsDic.getKeyByIndex(H),N=this.oldContactsDic.getDataByKey(L),M=N.shape0,F=N.shape1,V=M.collider,x=F.collider;if(V&&x){var G=V.isTrigger||x.isTrigger;if(null==this.contactsDic.getDataByKey(L))if(G)this.triggerArrayMat.get(M.id,F.id)&&(w.type="onTriggerExit",w.selfCollider=V,w.otherCollider=x,V.emit(w.type,w),w.selfCollider=x,w.otherCollider=V,x.emit(w.type,w),this.triggerArrayMat.set(M.id,F.id,!1),this.oldContactsDic.set(M.id,F.id,null));else if(this.collisionArrayMat.get(M.id,F.id)){K.push.apply(K,D.contacts),D.contacts.length=0;for(var k=0;k<N.contacts.length;k++){var X=N.contacts[k];if(K.length>0){var U=K.pop();U.impl=X,D.contacts.push(U)}else{var W=new j(D);W.impl=X,D.contacts.push(W)}}D.type="onCollisionExit",D.selfCollider=V,D.otherCollider=x,V.emit(D.type,D),D.selfCollider=x,D.otherCollider=V,x.emit(D.type,D),this.collisionArrayMat.set(M.id,F.id,!1),this.oldContactsDic.set(M.id,F.id,null)}}}this.contactsDic.reset()},s}(),q=H,Z=function(){var s=o.prototype;function o(t){this.id=void 0,this.type=void 0,this._index=-1,this._isEnabled=!1,this._isBinding=!1,this._isTrigger=!1,this._btCompound=null,this.transform=void 0,this.pos=void 0,this.quat=void 0,this.scale=void 0,this.type=t,this.id=o.idCounter++,this.pos=new p.btVector3,this.quat=new p.btQuaternion,this.transform=new p.btTransform(this.quat,this.pos),this.transform.setIdentity(),this.scale=new p.btVector3(1,1,1)}return s.setMaterial=function(t){!this._isTrigger&&this._isEnabled&&t&&(this._btCompound?this._btCompound.setMaterial(this._index,t.friction,t.restitution,t.rollingFriction,t.spinningFriction):(this._sharedBody.body.setFriction(t.friction),this._sharedBody.body.setRestitution(t.restitution),this._sharedBody.body.setRollingFriction(t.rollingFriction),this._sharedBody.body.setSpinningFriction(t.spinningFriction)))},s.setCenter=function(t){i.copy(q,t),q.multiply(this._collider.node.worldScale),y(this.transform.getOrigin(),q),this.updateCompoundTransform()},s.setAsTrigger=function(t){this._isTrigger!=t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},t(o,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"index",get:function(){return this._index}}]),s.getAABB=function(t){var e=Y.instance.TRANSFORM;e.setIdentity(),e.setRotation(g(Y.instance.QUAT_0,this._collider.node.worldRotation));var s=Y.instance.VECTOR3_0,o=Y.instance.VECTOR3_1;this._btShape.getAabb(e,s,o),t.halfExtents.set((o.x()-s.x())/2,(o.y()-s.y())/2,(o.z()-s.z())/2),i.add(t.center,this._collider.node.worldPosition,this._collider.center)},s.getBoundingSphere=function(t){t.radius=this._btShape.getLocalBoundingSphere(),i.add(t.center,this._collider.node.worldPosition,this._collider.center)},s.initialize=function(t){this._collider=t,this._isBinding=!0,this.onComponentSet(),this.setWrapper(),this._sharedBody=u.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},s.onComponentSet=function(){},s.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},s.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},s.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},s.onDestroy=function(){this._sharedBody.reference=!1,this._btCompound=null,this._collider=null,p.castObject(this._btShape,p.btCollisionShape).wrapped=null,p.destroy(this.pos),p.destroy(this.quat),p.destroy(this.scale),p.destroy(this.transform),p.destroy(this._btShape),E(this._btShape,p.btCollisionShape),this._btShape=null,this.transform=null,this.pos=null,this.quat=null,this.scale=null},s.getGroup=function(){return this._sharedBody.collisionFilterGroup},s.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},s.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},s.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},s.getMask=function(){return this._sharedBody.collisionFilterMask},s.setMask=function(t){this._sharedBody.collisionFilterMask=t},s.addMask=function(t){this._sharedBody.collisionFilterMask|=t},s.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},s.setCompound=function(t){this._btCompound&&(this._btCompound.removeChildShape(this._btShape),this._index=-1),t&&(this._index=t.getNumChildShapes(),t.addChildShape(this.transform,this._btShape)),this._btCompound=t},s.setWrapper=function(){p.castObject(this._btShape,p.btCollisionShape).wrapped=this},s.setScale=function(){this.setCenter(this._collider.center)},s.updateCompoundTransform=function(){this._btCompound?this._btCompound.updateChildTransform(this.index,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=T.BODY_RE_ADD)},s.needCompound=function(){return this.type==v.TERRAIN_SHAPE_PROXYTYPE||!this._collider.center.equals(i.ZERO)},s.debugTransform=function(t){var s;null==o._debugTransform&&(o._debugTransform=new p.btTransform),s=this._isTrigger?this._sharedBody.ghost.getWorldTransform():this._sharedBody.body.getWorldTransform();var n=this.transform;o._debugTransform.setIdentity(),o._debugTransform.op_mul(s).op_mul(n);var r=o._debugTransform.getOrigin();t.worldPosition=new i(r.x(),r.y(),r.z());var a=o._debugTransform.getRotation();t.worldRotation=new e(a.x(),a.y(),a.z(),a.w());var h=this.impl.getLocalScaling();t.scale=new i(h.x(),h.y(),h.z())},o}();Z.idCounter=0,Z._debugTransform=void 0;var $=H,tt=function(e){s(n,e);var o=n.prototype;function n(){var t;return(t=e.call(this,v.BOX_SHAPE_PROXYTYPE)||this).halfExt=void 0,t.halfExt=new p.btVector3(.5,.5,.5),t}return o.setSize=function(t){i.multiplyScalar($,t,.5),y(this.halfExt,$),this.impl.setUnscaledHalfExtents(this.halfExt),this.updateCompoundTransform()},t(n,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),o.onComponentSet=function(){var t=this.collider.size;this.halfExt.setValue(t.x/2,t.y/2,t.z/2),this._btShape=new p.btBoxShape(this.halfExt),this.setScale()},o.onDestroy=function(){p.destroy(this.halfExt),E(this.halfExt,p.btVector3),this.halfExt=null,e.prototype.onDestroy.call(this)},o.setScale=function(){e.prototype.setScale.call(this),y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},n}(Z),it=H,et=function(i){s(o,i);var e=o.prototype;function o(){return i.call(this,v.SPHERE_SHAPE_PROXYTYPE)||this}return e.setRadius=function(t){this.impl.setUnscaledRadius(t),this.updateCompoundTransform()},t(o,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new p.btSphereShape(this.collider.radius),this.setScale()},e.setScale=function(){i.prototype.setScale.call(this);var t=this._collider.node.worldScale,e=Math.abs(t.x),s=Math.abs(t.y),o=Math.abs(t.z),n=Math.max(Math.max(e,s),o);it.set(n,n,n),y(this.scale,it),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},o}(Z),st=function(i){s(n,i);var e=n.prototype;function n(){var t;return(t=i.call(this,v.CAPSULE_SHAPE_PROXYTYPE)||this)._btShape=new p.btCapsuleShape(.5,1),t}return e.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},t(n,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this.setRadius(this.collider.radius)},e.setScale=function(){i.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n=s,r=e;if(1==r){var a=t*Math.abs(o(n.x,n.z)),h=i/2*Math.abs(n.y);this.impl.updateProp(a,h,r)}else if(0==r){var l=t*Math.abs(o(n.y,n.z)),d=i/2*Math.abs(n.x);this.impl.updateProp(l,d,r)}else{var c=t*Math.abs(o(n.x,n.y)),p=i/2*Math.abs(n.z);this.impl.updateProp(c,p,r)}this.updateCompoundTransform()},n}(Z),ot=function(i){s(o,i);var e=o.prototype;function o(){var t;return(t=i.call(this,v.TRIANGLE_MESH_SHAPE_PROXYTYPE)||this).refBtTriangleMesh=null,t}return e.setMesh=function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!=Y.instance.EMPTY_SHAPE)n(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){var e=this._getBtTriangleMesh(i);this.collider.convex?this._btShape=new p.btConvexTriangleMeshShape(e,!0):this._btShape=new p.btBvhTriangleMeshShape(e,!0,!0),y(this.scale,this._collider.node.worldScale),this._btShape.setMargin(.01),this._btShape.setLocalScaling(this.scale),this.setWrapper(),this.setCompound(this._btCompound)}else this._btShape=Y.instance.EMPTY_SHAPE}},t(o,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),e.onComponentSet=function(){this.setMesh(this.collider.mesh)},e.onDestroy=function(){this.refBtTriangleMesh&&p.destroy(this.refBtTriangleMesh),i.prototype.onDestroy.call(this)},e.setCompound=function(t){i.prototype.setCompound.call(this,t),this.impl.setUserIndex(this._index)},e.setScale=function(){i.prototype.setScale.call(this),y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e._getBtTriangleMesh=function(t){var i;if(p.CC_CACHE.btTriangleMesh.enable){if(null==p.CC_CACHE.btTriangleMesh[t._uuid]){var e=new p.btTriangleMesh;p.CC_CACHE.btTriangleMesh[t._uuid]=e,m(e,t)}i=p.CC_CACHE.btTriangleMesh[t._uuid]}else this.refBtTriangleMesh=i=new p.btTriangleMesh,m(i,t);return i},o}(Z),nt=function(i){s(n,i);var e=n.prototype;function n(){var t;return(t=i.call(this,v.CYLINDER_SHAPE_PROXYTYPE)||this).halfExtents=void 0,t.halfExtents=new p.btVector3(.5,1,.5),t._btShape=new p.btCylinderShape(t.halfExtents),t}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},t(n,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this.setRadius(this.collider.radius)},e.onDestroy=function(){p.destroy(this.halfExtents),E(this.halfExtents,p.btVector3),i.prototype.onDestroy.call(this)},e.setScale=function(){i.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n=s,r=e;if(1==r){var a=i*Math.abs(n.y),h=t*Math.abs(o(n.x,n.z)),l=a/2;this.impl.updateProp(h,l,r)}else if(0==r){var d=i*Math.abs(n.x),c=t*Math.abs(o(n.y,n.z)),p=d/2;this.impl.updateProp(c,p,r)}else{var u=i*Math.abs(n.z),_=t*Math.abs(o(n.x,n.y)),S=u/2;this.impl.updateProp(_,S,r)}this.updateCompoundTransform()},n}(Z),rt=function(i){s(n,i);var e=n.prototype;function n(){var t;return(t=i.call(this,v.CONE_SHAPE_PROXYTYPE)||this)._btShape=new p.btConeShape(.5,1),t}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},t(n,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this.setRadius(this.collider.radius)},e.setScale=function(){i.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n=s,r=e;if(1==r){var a=i*Math.abs(n.y),h=t*Math.abs(o(n.x,n.z));this.impl.setRadius(h),this.impl.setHeight(a)}else if(0==r){var l=i*Math.abs(n.x),d=t*Math.abs(o(n.y,n.z));this.impl.setRadius(d),this.impl.setHeight(l)}else{var c=i*Math.abs(n.z),p=t*Math.abs(o(n.x,n.y));this.impl.setRadius(p),this.impl.setHeight(c)}this.impl.setConeUpIndex(r),this.scale.setValue(1,1,1),this.impl.setLocalScaling(this.scale),this.updateCompoundTransform()},n}(Z),at=function(e){s(n,e);var o=n.prototype;function n(){var t;return(t=e.call(this,v.TERRAIN_SHAPE_PROXYTYPE)||this)._terrainID=void 0,t._buffPtr=void 0,t._tileSize=void 0,t._localOffset=void 0,t._terrainID="",t._buffPtr=0,t._tileSize=0,t._localOffset=new i,t}return o.setTerrain=function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!=Y.instance.EMPTY_SHAPE)r("[Physics] Ammo change the terrain asset after initialization is not support.");else{var i=t;if(i){this._terrainID=i._uuid,this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._buffPtr=p._malloc(4*e*s);for(var o=0,n=Number.MIN_VALUE,a=Number.MAX_VALUE,h=0;h<s;h++)for(var l=0;l<e;l++){var d=i.getHeight(l,h);p.HEAPF32[this._buffPtr+o>>2]=d,n=n<d?d:n,a=a>d?d:a,o+=4}n+=.1,a-=.1,this._localOffset.set((e-1)/2*this._tileSize,(n+a)/2,(s-1)/2*this._tileSize),this._btShape=new p.btHeightfieldTerrainShape(e,s,this._buffPtr,1,a,n,1,"PHY_FLOAT",!1),this.scale.setValue(this._tileSize,1,this._tileSize),this._btShape.setLocalScaling(this.scale)}else this._btShape=Y.instance.EMPTY_SHAPE}},t(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),o.onComponentSet=function(){this.setTerrain(this.collider.terrain)},o.onDestroy=function(){this._buffPtr&&p._free(this._buffPtr),e.prototype.onDestroy.call(this)},o.setCompound=function(t){e.prototype.setCompound.call(this,t),this.impl.setUserIndex(this._index)},o.setCenter=function(t){i.copy(H,t),H.add(this._localOffset),y(this.transform.getOrigin(),H),this.updateCompoundTransform()},n}(Z),ht=function(i){s(o,i);var e=o.prototype;function o(){var t;return(t=i.call(this,v.TETRAHEDRAL_SHAPE_PROXYTYPE)||this).VERTICES=[],t}return e.setShapeType=function(){this._isBinding},e.setVertices=function(t){for(var i=this.VERTICES.length,e=0;e<i;e++)y(this.VERTICES[e],t[e]);y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},t(o,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new p.btBU_Simplex1to4;for(var t=this.collider.shapeType,i=this.collider.vertices,e=0;e<t;e++)this.VERTICES[e]=new p.btVector3,y(this.VERTICES[e],i[e]),this.impl.addVertex(this.VERTICES[e]);y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale)},e.onLoad=function(){i.prototype.onLoad.call(this),this.collider.updateVertices()},e.onDestroy=function(){for(var t=this.VERTICES.length,e=0;e<t;e++)p.destroy(this.VERTICES[e]);this.VERTICES=null,i.prototype.onDestroy.call(this)},e.setScale=function(){i.prototype.setScale.call(this),y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},o}(Z),lt=function(i){s(o,i);var e=o.prototype;function o(){var t;return(t=i.call(this,v.STATIC_PLANE_PROXYTYPE)||this).NORMAL=void 0,t.NORMAL=new p.btVector3(0,1,0),t}return e.setNormal=function(t){y(this.impl.getPlaneNormal(),t),this.updateCompoundTransform()},e.setConstant=function(t){this.impl.setPlaneConstant(t),this.updateCompoundTransform()},e.setScale=function(){i.prototype.setScale.call(this),y(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},t(o,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){y(this.NORMAL,this.collider.normal),this._btShape=new p.btStaticPlaneShape(this.NORMAL,this.collider.constant),this.setScale()},e.onDestroy=function(){i.prototype.onDestroy.call(this),p.destroy(this.NORMAL),E(this.NORMAL,p.btVector3),this.NORMAL=null},o}(Z),dt=function(){function i(){this.dirty=0,this.index=-1,this._rigidBody=null,this._collided=!1}var e=i.prototype;return e.setConnectedBody=function(){},e.setEnableCollision=function(t){this._collided!=t&&(this._collided=t,this.updateByReAdd())},e.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._collided=t.enableCollision,this.onComponentSet()},e.onComponentSet=function(){},e.onLoad=function(){},e.onEnable=function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.addConstraint(this)},e.onDisable=function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.removeConstraint(this)},e.onDestroy=function(){p.destroy(this._impl),this._com=null,this._rigidBody=null,this._impl=null},t(i,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),i}(),ct=function(e){function o(){return e.apply(this,arguments)||this}s(o,e);var n=o.prototype;return n.setPivotA=function(t){this._pivotA&&(i.multiply(H,t,this._com.node.worldScale),y(this._pivotA,H),this.impl.setPivotA(this._pivotA))},n.setPivotB=function(t){i.copy(H,t);var e=this._com.connectedBody;e?i.multiply(H,t,e.node.worldScale):(i.add(H,H,this._com.node.worldPosition),i.multiply(L,this.constraint.pivotA,this._com.node.worldScale),i.add(H,H,L)),y(this._pivotB,H),this.impl.setPivotB(this._pivotB)},n.onComponentSet=function(){if(this._rigidBody){var t,i=this._rigidBody.body.impl,e=this.constraint.connectedBody;e&&(t=e.body.impl),this._pivotA=new p.btVector3,this._pivotB=new p.btVector3,this._impl=t?new p.btPoint2PointConstraint(i,t,this._pivotA,this._pivotB):new p.btPoint2PointConstraint(i,this._pivotA),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)}},t(o,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),o}(dt),pt=function(o){function n(){return o.apply(this,arguments)||this}s(n,o);var r=n.prototype;return r.setPivotA=function(t){this._pivotA&&(i.multiply(H,t,this._com.node.worldScale),y(this._pivotA,H))},r.setPivotB=function(t){if(this._pivotB){i.copy(H,t);var e=this._com.connectedBody;e&&i.multiply(H,t,e.node.worldScale),y(this._pivotB,H)}},r.setAxisA=function(){},r.setAxisB=function(){},r.onComponentSet=function(){if(this._rigidBody){var t,s=this._rigidBody.body.impl,o=this.constraint.connectedBody;if(o&&(t=o.body.impl),this._pivotA=new p.btVector3,this._pivotB=new p.btVector3,this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this._axisA=new p.btVector3,this._axisB=new p.btVector3,y(this._axisA,this.constraint.axisA),y(this._axisB,this.constraint.axisB),t)this._impl=new p.btHingeConstraint(s,t,this._pivotA,this._pivotB,this._axisA,this._axisB);else{var n=new e;e.rotationTo(n,i.UNIT_Z,this.constraint.axisA);var r=new p.btQuaternion(n.x,n.y,n.z,n.w),a=new p.btTransform;a.setIdentity(),a.setOrigin(this._pivotA),a.setRotation(r),this._impl=new p.btHingeConstraint(s,a)}}},t(n,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),n}(dt);a(st.prototype,"shape.prototype",[{name:"setHeight",suggest:"You should use the interface provided by the component."}]),h(j.prototype,"IContactEquation.prototype",[{name:"contactA",newName:"getLocalPointOnA",customGetter:function(){var t=new i;return j.prototype.getLocalPointOnA.call(this,t),t}},{name:"contactB",newName:"getLocalPointOnB",customGetter:function(){var t=new i;return j.prototype.getLocalPointOnB.call(this,t),t}},{name:"normal",newName:"getLocalNormalOnB",customGetter:function(){var t=new i;return j.prototype.getLocalNormalOnB.call(this,t),t}}]),_("ammo.js",{PhysicsWorld:J,RigidBody:V,BoxShape:tt,SphereShape:et,CapsuleShape:st,TrimeshShape:ot,CylinderShape:nt,ConeShape:rt,TerrainShape:at,SimplexShape:ht,PlaneShape:lt,PointToPointConstraint:ct,HingeConstraint:pt}),null==window.atob&&(window.atob=function(t){var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="",s=0,o=0,n=0,r=0,a=0,h=0,l=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{s=i.indexOf(t.charAt(l++))<<2|(r=i.indexOf(t.charAt(l++)))>>4,o=(15&r)<<4|(a=i.indexOf(t.charAt(l++)))>>2,n=(3&a)<<6|(h=i.indexOf(t.charAt(l++))),e+=String.fromCharCode(s),64!==a&&(e+=String.fromCharCode(o)),64!==h&&(e+=String.fromCharCode(n))}while(l<t.length);return e}),window.Ammo=p,p.CC_CONFIG={ignoreSelfBody:!0,emitStaticCollision:!1},p.CC_CACHE={btTriangleMesh:{enable:!1}}}}}));
