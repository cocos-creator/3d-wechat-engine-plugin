System.register(["./deprecated-0768b3d4.js"],(function(t){"use strict";var e,i,n,o,r,s,a,u,_,d,h,c,l,p,f,v;return{setters:[function(t){e=t.l,i=t.i,n=t._,o=t.g,r=t.f,s=t.E,a=t.c,u=t.t,_=t.a,d=t.A,h=t.b,c=t.o,l=t.e,p=t.s,f=t.k,v=t.n}],execute:function(){t({a:M,b:function(t,e,i){if(0!==R.length){(V.WEB_AUDIO&&e.audioLoadMode!==B.DOM_AUDIO?H:k)(t,e,i)}else i(new Error(v(4927)))},d:k});var m={INITIALIZING:0,PLAYING:1,STOPPED:2},g=function(){function t(t){var i=this;this._state=m.STOPPED,this._duration=0,this._clip=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=t.duration,this._clip=t.audioClip,this._onHide=function(){i._blocking=!0,i._state===m.PLAYING&&(i.pause(),i._interrupted=!0)},this._onShow=function(){i._blocking=!1,i._interrupted&&(i.play(),i._interrupted=!1)},e.game.on(e.Game.EVENT_HIDE,this._onHide),e.game.on(e.Game.EVENT_SHOW,this._onShow)}var i=t.prototype;return i.getState=function(){return this._state},i.getDuration=function(){return this._duration},i.destroy=function(){e.game.off(e.Game.EVENT_HIDE,this._onHide),e.game.off(e.Game.EVENT_SHOW,this._onShow)},t}();e.internal.AudioPlayer=g;var y=i.__audioSupport;function A(t){return new Promise((function(e,i){var n=document.createElement("audio");n.src=t;var o=function(){clearTimeout(r),n.removeEventListener("canplaythrough",s,!1),n.removeEventListener("error",a,!1),y.USE_LOADER_EVENT&&n.removeEventListener(y.USE_LOADER_EVENT,s,!1)},r=setTimeout((function(){0===n.readyState?a():s()}),8e3),s=function(){o(),e(n)},a=function(){o(),i("load audio failure - "+t)};n.addEventListener("canplaythrough",s,!1),n.addEventListener("error",a,!1),y.USE_LOADER_EVENT&&n.addEventListener(y.USE_LOADER_EVENT,s,!1)}))}var E=function(){function t(){this._playingAudios=void 0,this._playingAudios=[]}var e=t.prototype;return e.addPlaying=function(t){this._playingAudios.push(t)},e.removePlaying=function(t){var e=this._playingAudios.indexOf(t);e>-1&&this._playingAudios.splice(e,1)},t}();E.maxAudioChannel=24,e.internal.AudioManager=E;var T=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e.prototype.discardOnePlayingIfNeeded=function(){if(!(this._playingAudios.length<E.maxAudioChannel)){var t,e,i=this._playingAudios.findIndex((function(t){return t instanceof HTMLAudioElement}));i>-1?(t=this._playingAudios[i],this._playingAudios.splice(i,1),t.pause(),t.src=""):null===(e=t=this._playingAudios.shift())||void 0===e||e.stop()}},e}(E),P=function(t){function i(n){var o;return(o=t.call(this,n)||this)._volume=1,o._loop=!1,o._nativeAudio=void 0,o._cbRegistered=!1,o._remove_cb=void 0,o._post_play=void 0,o._on_gesture=void 0,o._post_gesture=void 0,o._nativeAudio=n.nativeAudio,o._remove_cb=function(){o._cbRegistered&&(e.game.canvas.removeEventListener("touchend",o._on_gesture),e.game.canvas.removeEventListener("mouseup",o._on_gesture),o._cbRegistered=!1)},o._post_play=function(){o._state=m.PLAYING,o._clip.emit("started"),o._remove_cb(),i._manager.addPlaying(r(o))},o._post_gesture=function(){o._interrupted?(o._post_play(),o._interrupted=!1):(o._nativeAudio.pause(),o._nativeAudio.currentTime=0)},o._on_gesture=function(){if(o._nativeAudio){var t=o._nativeAudio.play();if(!t)return o._state=m.PLAYING,void e.director.once(e.Director.EVENT_AFTER_UPDATE,o._post_gesture);t.then(o._post_gesture),o._remove_cb()}},o._nativeAudio.volume=o._volume,o._nativeAudio.loop=o._loop,o._nativeAudio.addEventListener("ended",(function(){o._state=m.STOPPED,o._nativeAudio.currentTime=0,o._clip.emit("ended"),i._manager.removePlaying(r(o))})),e.game.canvas.addEventListener("touchend",o._on_gesture),e.game.canvas.addEventListener("mouseup",o._on_gesture),o._cbRegistered=!0,o}n(i,t);var s=i.prototype;return s.play=function(){var t=this;if(this._nativeAudio)if(this._blocking)this._interrupted=!0;else{this._state===m.PLAYING&&(this.pause(),this.setCurrentTime(0)),i._manager.discardOnePlayingIfNeeded();var n=this._nativeAudio.play();if(!n)return this._state=m.PLAYING,void e.director.once(e.Director.EVENT_AFTER_UPDATE,this._post_play);n.then(this._post_play).catch((function(){t._interrupted=!0}))}},s.pause=function(){this._nativeAudio&&(this._interrupted=!1,this._state===m.PLAYING&&(this._nativeAudio.pause(),this._state=m.STOPPED,i._manager.removePlaying(this)))},s.stop=function(){this._nativeAudio&&(this._nativeAudio.currentTime=0,this._interrupted=!1,this._state===m.PLAYING&&(this._nativeAudio.pause(),this._state=m.STOPPED,i._manager.removePlaying(this)))},s.playOneShot=function(t){void 0===t&&(t=1),A(this._nativeAudio.src).then((function(e){i._manager.discardOnePlayingIfNeeded(),e.volume=t,e.play(),i._manager.addPlaying(e),e.addEventListener("ended",(function(){i._manager.removePlaying(e)}))}),(function(t){console.error(t)}))},s.setCurrentTime=function(t){this._nativeAudio&&(this._nativeAudio.currentTime=o(t,0,this._duration))},s.getCurrentTime=function(){return this._nativeAudio?this._nativeAudio.currentTime:0},s.setVolume=function(t){this._volume=t,this._nativeAudio&&(this._nativeAudio.volume=t)},s.getVolume=function(){return this._nativeAudio?this._nativeAudio.volume:this._volume},s.setLoop=function(t){this._loop=t,this._nativeAudio&&(this._nativeAudio.loop=t)},s.getLoop=function(){return this._loop},s.destroy=function(){this._nativeAudio&&(this._nativeAudio.src=""),t.prototype.destroy.call(this)},i}(g);P._manager=new T;var N,I,L,x,D,O,S,G,C=i.__audioSupport,b=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e.prototype.discardOnePlayingIfNeeded=function(){var t;if(!(this._playingAudios.length<E.maxAudioChannel)){var e,i=this._playingAudios.findIndex((function(t){return t instanceof AudioBufferSourceNode}));i>-1?(e=this._playingAudios[i],this._playingAudios.splice(i,1)):e=this._playingAudios.shift(),null===(t=e)||void 0===t||t.stop()}},e}(E),w=function(t){function i(i){var n;return(n=t.call(this,i)||this)._startTime=0,n._offset=0,n._volume=1,n._loop=!1,n._currentTimer=0,n._nativeAudio=void 0,n._context=void 0,n._sourceNode=void 0,n._gainNode=void 0,n._startInvoked=!1,n._onEndedCB=void 0,n._onGestureCB=void 0,n._onGestureProceedCB=void 0,n._nativeAudio=i.nativeAudio,n._context=C.context,n._sourceNode=n._context.createBufferSource(),n._gainNode=n._context.createGain(),n._gainNode.connect(n._context.destination),n._onEndedCB=n._onEnded.bind(r(n)),n._onGestureCB=n._onGesture.bind(r(n)),n._onGestureProceedCB=n._onGestureProceed.bind(r(n)),"running"!==n._context.state&&n._context.resume&&(e.game.canvas.addEventListener("touchend",n._onGestureCB),e.game.canvas.addEventListener("mouseup",n._onGestureCB)),n}n(i,t);var s=i.prototype;return s.play=function(){if(this._nativeAudio){if(this._state===m.PLAYING&&(this.pause(),this.setCurrentTime(0)),this._blocking||"running"!==this._context.state)return this._interrupted=!0,void("interrupted"!==this._context.state&&"suspended"!==this._context.state||!this._context.resume||this._onGesture());this._doPlay()}},s.pause=function(){this._interrupted=!1,this._state===m.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=m.STOPPED,clearInterval(this._currentTimer))},s.stop=function(){this._offset=0,this._interrupted=!1,this._state===m.PLAYING&&(this._doStop(),this._state=m.STOPPED,clearInterval(this._currentTimer))},s.playOneShot=function(t){if(void 0===t&&(t=1),this._nativeAudio){i._manager.discardOnePlayingIfNeeded();var e=this._context.createGain();e.connect(this._context.destination),e.gain.value=t;var n=this._context.createBufferSource();n.buffer=this._nativeAudio,n.loop=!1,n.connect(e),n.start(),i._manager.addPlaying(n),n.onended=function(){i._manager.removePlaying(n)}}},s.setCurrentTime=function(t){this._offset=o(t,0,this._nativeAudio&&this._nativeAudio.duration||this._duration),this._state===m.PLAYING&&(this._doStop(),this._doPlay())},s.getCurrentTime=function(){return this._state!==m.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset},s.setVolume=function(t,e){if(this._volume=t,!e&&this._gainNode.gain.setTargetAtTime)try{this._gainNode.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(e){this._gainNode.gain.setTargetAtTime(t,this._context.currentTime,.01)}else this._gainNode.gain.value=t},s.getVolume=function(){return this._volume},s.setLoop=function(t){this._loop=t,this._sourceNode.loop=t},s.getLoop=function(){return this._loop},s.destroy=function(){t.prototype.destroy.call(this)},s._doPlay=function(){var t=this;i._manager.discardOnePlayingIfNeeded(),this._state=m.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._nativeAudio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,e.director.once(e.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval((function(){t._onEnded(),clearInterval(t._currentTimer),t._sourceNode.loop&&(t._currentTimer=window.setInterval(t._onEndedCB,1e3*t._nativeAudio.duration))}),1e3*(this._nativeAudio.duration-this._offset))},s._doStop=function(){this._startInvoked?this._sourceNode.stop():e.director.off(e.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),i._manager.removePlaying(this)},s._playAndEmit=function(){this._sourceNode.start(0,this._offset),this._clip.emit("started"),this._startInvoked=!0,i._manager.addPlaying(this)},s._onEnded=function(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._clip.emit("ended"),this._state=m.STOPPED,i._manager.removePlaying(this))},s._onGestureProceed=function(){this._interrupted&&(this._doPlay(),this._interrupted=!1),e.game.canvas.removeEventListener("touchend",this._onGestureCB),e.game.canvas.removeEventListener("mouseup",this._onGestureCB)},s._onGesture=function(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB):this._onGestureProceed()},i}(g);w._manager=new b;var B=s({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3}),U=t("A",(N=a("cc.AudioClip"),I=u(B),N((G=S=function(t){function e(){var e;return e=t.call(this)||this,l(e,"_duration",D,r(e)),l(e,"_loadMode",O,r(e)),e._nativeAudio=null,e._player=null,e.loaded=!1,e}n(e,t);var i=e.prototype;return i.destroy=function(){return this._player&&this._player.destroy(),t.prototype.destroy.call(this)},i.play=function(){this._player&&this._player.play()},i.pause=function(){this._player&&this._player.pause()},i.stop=function(){this._player&&this._player.stop()},i.playOneShot=function(t){this._player&&this._player.playOneShot(t)},i.setCurrentTime=function(t){this._player&&this._player.setCurrentTime(t)},i.getCurrentTime=function(){return this._player?this._player.getCurrentTime():0},i.getDuration=function(){return this._player?this._player.getDuration():this._duration},i.setVolume=function(t,e){this._player&&this._player.setVolume(t,e||!1)},i.getVolume=function(){return this._player?this._player.getVolume():1},i.setLoop=function(t){this._player&&this._player.setLoop(t)},i.getLoop=function(){return!!this._player&&this._player.getLoop()},i._getPlayer=function(t){var e;return"undefined"!=typeof AudioBuffer&&t instanceof AudioBuffer?(e=w,this._loadMode=B.WEB_AUDIO):(e=P,this._loadMode=B.DOM_AUDIO),e},_(e,[{key:"_nativeAsset",set:function(t){if(this._nativeAudio=t,t){var e=this._getPlayer(t);this._player=new e({nativeAudio:t,duration:this._duration,audioClip:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=B.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1},get:function(){return this._nativeAudio}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():m.INITIALIZING}}]),e}(d),S.PlayingState=m,S.AudioType=B,S.preventDeferredLoadDependents=!0,D=h((x=G).prototype,"_duration",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O=h(x.prototype,"_loadMode",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B.UNKNOWN_AUDIO}}),h(x.prototype,"_nativeDep",[c],Object.getOwnPropertyDescriptor(x.prototype,"_nativeDep"),x.prototype),L=x))||L));function M(t,e,i,n){var o=new XMLHttpRequest,r="download failed: "+t+", status: ";if(o.open("GET",t,!0),void 0!==e.xhrResponseType&&(o.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(o.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&o.overrideMimeType&&o.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(o.timeout=e.xhrTimeout),e.xhrHeader)for(var s in e.xhrHeader)o.setRequestHeader(s,e.xhrHeader[s]);return o.onload=function(){200===o.status||0===o.status?n&&n(null,o.response):n&&n(new Error(r+o.status+"(no response)"))},i&&(o.onprogress=function(t){t.lengthComputable&&i(t.loaded,t.total)}),o.onerror=function(){n&&n(new Error(r+o.status+"(error)"))},o.ontimeout=function(){n&&n(new Error(r+o.status+"(time out)"))},o.onabort=function(){n&&n(new Error(r+o.status+"(abort)"))},o.send(null),o}e.AudioClip=U;var V=i.__audioSupport,R=V.format;function k(t,e,i){A(t).then((function(t){i(null,t)}),(function(t){f(t),i(new Error(t),null)}))}function H(t,e,i){e.xhrResponseType="arraybuffer",M(t,e,e.onFileProgress,i)}}}}));
