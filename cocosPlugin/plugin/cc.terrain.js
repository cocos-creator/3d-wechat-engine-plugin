System.register(["./deprecated-0768b3d4.js","./deprecated-4df5f565.js","./audio-downloader-f2f97571.js","./index-0614c00d.js","./deprecated-88eb2353.js","./screen-f991c158.js","./terrain-asset-62469b77.js"],(function(t){"use strict";var e,i,r,n,s,a,o,l,h,u,_,c,f,g,p,d,b,y,M,v,w,m,S,z,k,C,A,x,I,E,R,N,T,L,P,B,O,U,H,D,V,F,X,W,j,G,Y,K,q,J,Z,Q,$,tt,et;return{setters:[function(t){e=t.g,i=t.V,r=t.c,n=t.a,s=t.b,a=t._,o=t.l,l=t.t,h=t.aH,u=t.W,_=t.Z,c=t.a8,f=t.aJ,g=t.b5,p=t.Q,d=t.aG,b=t.T,y=t.e,M=t.a6,v=t.s,w=t.h,m=t.bh,S=t.f,z=t.C,k=t.bg},function(t){C=t.bK,A=t.dU,x=t.dW,I=t.B,E=t.b,R=t.M,N=t.A,T=t.a,L=t.F,P=t.bL,B=t.P,O=t.K,U=t.bH,H=t.ec,D=t.eE,V=t.eN,F=t.bJ,X=t.e7},function(){},function(){},function(t){W=t.h,j=t.m},function(){},function(e){G=e.a,Y=e.b,K=e.c,q=e.T,J=e.d,Z=e.e,Q=e.f,$=e.g,tt=e.h,et=e.i;var i={};i.TERRAIN_BLOCK_TILE_COMPLEXITY=e.b,i.TERRAIN_BLOCK_VERTEX_COMPLEXITY=e.a,i.TERRAIN_BLOCK_VERTEX_SIZE=e.c,i.TERRAIN_DATA_VERSION=e.p,i.TERRAIN_DATA_VERSION2=e.q,i.TERRAIN_DATA_VERSION3=e.r,i.TERRAIN_DATA_VERSION4=e.s,i.TERRAIN_DATA_VERSION_DEFAULT=e.t,i.TERRAIN_EAST_INDEX=e.o,i.TERRAIN_HEIGHT_BASE=e.f,i.TERRAIN_HEIGHT_FACTORY=e.g,i.TERRAIN_HEIGHT_FMAX=e.d,i.TERRAIN_HEIGHT_FMIN=e.e,i.TERRAIN_MAX_BLEND_LAYERS=e.k,i.TERRAIN_MAX_LAYER_COUNT=e.h,i.TERRAIN_MAX_LEVELS=e.j,i.TERRAIN_NORTH_INDEX=e.l,i.TERRAIN_SOUTH_INDEX=e.m,i.TERRAIN_WEST_INDEX=e.n,i.TerrainAsset=e.T,i.TerrainLayerInfo=e.i,t(i)}],execute:function(){t("HeightField",function(){function t(t,e){this.data=new Uint16Array,this.w=0,this.h=0,this.w=t,this.h=e,this.data=new Uint16Array(t*e);for(var i=0;i<t*e;++i)this.data[i]=0}var i=t.prototype;return i.set=function(t,e,i){this.data[e*this.w+t]=i},i.get=function(t,e){return this.data[e*this.w+t]},i.getClamp=function(t,i){return t=e(t,0,this.w-1),i=e(i,0,this.h-1),this.get(t,i)},i.getAt=function(t,i){var r=t,n=i,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,u=n-a;s=e(s,0,this.w-1),a=e(a,0,this.h-1),o=e(o,0,this.w-1),l=e(l,0,this.h-1);var _=this.get(s,a),c=this.get(o,a),f=this.get(s,l),g=this.get(o,l),p=.5*(c+f);return h+u<=1?g=p+(p-_):_=p+(p-g),(_*(1-h)+c*h)*(1-u)+(f*(1-h)+g*h)*u},t}());var it,rt,nt,st,at,ot,lt,ht,ut,_t,ct,ft,gt,pt,dt,bt,yt,Mt,vt,wt,mt,St,zt,kt,Ct,At,xt,It,Et,Rt,Nt,Tt,Lt,Pt,Bt,Ot,Ut,Ht,Dt,Vt,Ft,Xt,Wt,jt,Gt,Yt,Kt,qt,Jt,Zt,Qt,$t,te,ee=new i,ie=new i,re=t("TerrainInfo",r("cc.TerrainInfo")((lt=function(){function t(){y(this,"tileSize",nt,this),y(this,"blockCount",st,this),y(this,"weightMapSize",at,this),y(this,"lightMapSize",ot,this)}return n(t,[{key:"size",get:function(){var t=new M(0,0);return t.width=this.blockCount[0]*Y*this.tileSize,t.height=this.blockCount[1]*Y*this.tileSize,t}},{key:"tileCount",get:function(){var t=[0,0];return t[0]=this.blockCount[0]*Y,t[1]=this.blockCount[1]*Y,t}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}}]),t}(),nt=s((rt=lt).prototype,"tileSize",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st=s(rt.prototype,"blockCount",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),at=s(rt.prototype,"weightMapSize",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),ot=s(rt.prototype,"lightMapSize",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),it=rt))||it),ne=t("TerrainLayer",r("cc.TerrainLayer")((_t=s((ut=function(){y(this,"detailMap",_t,this),y(this,"normalMap",ct,this),y(this,"tileSize",ft,this),y(this,"metallic",gt,this),y(this,"roughness",pt,this)}).prototype,"detailMap",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ct=s(ut.prototype,"normalMap",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ft=s(ut.prototype,"tileSize",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gt=s(ut.prototype,"metallic",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pt=s(ut.prototype,"roughness",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ht=ut))||ht),se=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(e=t.call.apply(t,[this].concat(r))||this)._model=null,e._meshData=null,e._brushMaterial=null,e._currentMaterial=null,e._currentMaterialLayers=0,e}a(e,t);var i=e.prototype;return i.destroy=function(){return null!=this._model&&(o.director.root.destroyModel(this._model),this._model=null),t.prototype.destroy.call(this)},i._destroyModel=function(){null!=this._model&&(o.director.root.destroyModel(this._model),this._model=null)},i._invalidMaterial=function(){null!=this._currentMaterial&&(this._clearMaterials(),this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))},i._updateMaterial=function(t,e){if(null!=this._meshData&&null!=this._model){var i=t.getMaxLayer();null!=this._currentMaterial&&i===this._currentMaterialLayers||(this._currentMaterial=new C,this._currentMaterial.initialize({effectAsset:t.getTerrain().getEffectAsset(),defines:t._getMaterialDefines(i)}),null!==this._brushMaterial&&this._currentMaterial.passes.push(this._brushMaterial.passes[0]),e&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0,this._model.receiveShadow=t.getTerrain().receiveShadow)}},i._onMaterialModified=function(t,e){null!=this._model&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},i._onRebuildPSO=function(t,e){this._model&&this._model.setSubModelMaterial(t,e)},i._clearMaterials=function(){null!=this._model&&this._onMaterialModified(0,null)},i._getBuiltinMaterial=function(){return A.get("missing-material")},e}(x),ae=t("TerrainBlockInfo",(dt=r("cc.TerrainBlockInfo"),bt=l([h]),dt((vt=s((Mt=function(){y(this,"layers",vt,this)}).prototype,"layers",[bt,v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),yt=Mt))||yt)),oe=t("TerrainBlockLightmapInfo",r("cc.TerrainBlockLightmapInfo")((St=s((mt=function(){y(this,"texture",St,this),y(this,"UOff",zt,this),y(this,"VOff",kt,this),y(this,"UScale",Ct,this),y(this,"VScale",At,this)}).prototype,"texture",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zt=s(mt.prototype,"UOff",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kt=s(mt.prototype,"VOff",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ct=s(mt.prototype,"UScale",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),At=s(mt.prototype,"VScale",[v,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wt=mt))||wt),le=t("TerrainBlock",function(){function t(t,e,i){this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._terrain=t,this._info=t.getBlockInfo(e,i),this._index[0]=e,this._index[1]=i,this._lightmapInfo=t._getLightmapInfo(e,i),this._node=new j(""),this._node.setParent(this._terrain.node),this._node._objFlags|=o.Object.Flags.DontSave,this._renderable=this._node.addComponent(se)}var e=t.prototype;return e.build=function(){var t=W.root.device,e=new Float32Array(K*G*G),r=0;ee.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ie.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var n=0;n<G;++n)for(var s=0;s<G;++s){var a=this._index[0]*Y+s,l=this._index[1]*Y+n,h=this._terrain.getPosition(a,l),_=this._terrain.getNormal(a,l),c=new u(s/Y,n/Y);e[r++]=h.x,e[r++]=h.y,e[r++]=h.z,e[r++]=_.x,e[r++]=_.y,e[r++]=_.z,e[r++]=c.x,e[r++]=c.y,i.min(ee,ee,h),i.max(ie,ie,h)}var f=t.createBuffer(new I(E.VERTEX|E.TRANSFER_DST,R.HOST|R.DEVICE,K*Float32Array.BYTES_PER_ELEMENT*G*G,K*Float32Array.BYTES_PER_ELEMENT));f.update(e);var g=[new N(T.ATTR_POSITION,L.RGB32F),new N(T.ATTR_NORMAL,L.RGB32F),new N(T.ATTR_TEX_COORD,L.RG32F)];this._renderable._meshData=new P([f],g,B.TRIANGLE_LIST,this._terrain._getSharedIndexBuffer());var p=this._renderable._model=o.director.root.createModel(O);p.node=p.transform=this._terrain.node,p.createBoundingShape(ee,ie),this._renderable._getRenderScene().addModel(p),this._updateWeightMap(),this._updateMaterial(!0)},e.rebuild=function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)},e.destroy=function(){this._renderable._destroyModel(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()},e.update=function(){this._updateMaterial(!1);var t=this._terrain.useNormalMap,e=this._terrain.usePBR,i=function(t){return null!==t?t.detailMap:null},r=function(t){var e=null!==t?t.normalMap:null;return null===e&&(e=o.builtinResMgr.get("normal-texture")),e},n=this._renderable._currentMaterial;if(null!==n){var s=this.getMaxLayer(),a=new _(1,1,1,1),l=new _(1,1,1,1),h=new _(0,0,0,0);if(0===s)if(-1!==this.layers[0]){var u=this._terrain.getLayer(this.layers[0]);null!==u&&(a.x=1/u.tileSize,l.x=u.roughness,h.x=u.metallic),n.setProperty("detailMap0",i(u)),t&&n.setProperty("normalMap0",r(u))}else n.setProperty("detailMap0",o.builtinResMgr.get("default-texture")),t&&n.setProperty("normalMap0",o.builtinResMgr.get("normal-texture"));else if(1===s){var c=this._terrain.getLayer(this.layers[0]),f=this._terrain.getLayer(this.layers[1]);null!==c&&(a.x=1/c.tileSize,l.x=c.roughness,h.x=c.metallic),null!==f&&(a.y=1/f.tileSize,l.y=f.roughness,h.y=f.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(c)),n.setProperty("detailMap1",i(f)),t&&(n.setProperty("normalMap0",r(c)),n.setProperty("normalMap1",r(f)))}else if(2===s){var g=this._terrain.getLayer(this.layers[0]),p=this._terrain.getLayer(this.layers[1]),d=this._terrain.getLayer(this.layers[2]);null!==g&&(a.x=1/g.tileSize,l.x=g.roughness,h.x=g.metallic),null!==p&&(a.y=1/p.tileSize,l.y=p.roughness,h.y=p.metallic),null!==d&&(a.z=1/d.tileSize,l.z=d.roughness,h.z=d.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(g)),n.setProperty("detailMap1",i(p)),n.setProperty("detailMap2",i(d)),t&&(n.setProperty("normalMap0",r(g)),n.setProperty("normalMap1",r(p)),n.setProperty("normalMap2",r(d)))}else if(3===s){var b=this._terrain.getLayer(this.layers[0]),y=this._terrain.getLayer(this.layers[1]),M=this._terrain.getLayer(this.layers[2]),v=this._terrain.getLayer(this.layers[3]);null!==b&&(a.x=1/b.tileSize,l.x=b.roughness,h.x=b.metallic),null!==y&&(a.y=1/y.tileSize,l.y=y.roughness,h.y=y.metallic),null!==M&&(a.z=1/M.tileSize,l.z=M.roughness,h.z=M.metallic),null!==v&&(a.w=1/v.tileSize,l.w=v.roughness,h.w=v.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(b)),n.setProperty("detailMap1",i(y)),n.setProperty("detailMap2",i(M)),n.setProperty("detailMap3",i(v)),t&&(n.setProperty("normalMap0",r(b)),n.setProperty("normalMap1",r(y)),n.setProperty("normalMap2",r(M)),n.setProperty("normalMap3",r(v)))}n.setProperty("UVScale",a),e&&(n.setProperty("roughness",l),n.setProperty("metallic",h)),null!==this.lightmap&&(n.setProperty("lightMap",this.lightmap),n.setProperty("lightMapUVParam",this.lightmapUVParam))}},e.setBrushMaterial=function(t){this._renderable._brushMaterial!==t&&(this._renderable._brushMaterial=t,this._renderable._invalidMaterial())},e.getTerrain=function(){return this._terrain},e.getIndex=function(){return this._index},e.getRect=function(){var t=new c;return t.x=this._index[0]*Y,t.y=this._index[1]*Y,t.width=Y,t.height=Y,t},e.setLayer=function(t,e){this.layers[t]!==e&&(this.layers[t]=e,this._renderable._invalidMaterial(),this._updateMaterial(!1))},e.getLayer=function(t){return this.layers[t]},e.getMaxLayer=function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0},e._getMaterialDefines=function(t){return{LAYERS:t+1,USE_LIGHTMAP:null!==this.lightmap?1:0,USE_NORMALMAP:this._terrain.useNormalMap?1:0,USE_PBR:this._terrain.usePBR?1:0}},e._invalidMaterial=function(){this._renderable._invalidMaterial()},e._updateMaterial=function(t){this._renderable._updateMaterial(this,t)},e._updateHeight=function(){if(null!=this._renderable._meshData){var t=new Float32Array(K*G*G),e=0;ee.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ie.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var r=0;r<G;++r)for(var n=0;n<G;++n){var s=this._index[0]*Y+n,a=this._index[1]*Y+r,o=this._terrain.getPosition(s,a),l=this._terrain.getNormal(s,a),h=new u(n/G,r/G);t[e++]=o.x,t[e++]=o.y,t[e++]=o.z,t[e++]=l.x,t[e++]=l.y,t[e++]=l.z,t[e++]=h.x,t[e++]=h.y,i.min(ee,ee,o),i.max(ie,ie,o)}this._renderable._meshData.vertexBuffers[0].update(t),this._renderable._model.createBoundingShape(ee,ie)}},e._updateWeightMap=function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new U,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,H.RGBA8888),this._weightMap.setFilters(D.LINEAR,D.LINEAR),this._weightMap.setWrapMode(V.CLAMP_TO_EDGE,V.CLAMP_TO_EDGE));for(var t=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),e=0,i=0;i<this._terrain.weightMapSize;++i)for(var r=0;r<this._terrain.weightMapSize;++r){var n=this._index[0]*this._terrain.weightMapSize+r,s=this._index[1]*this._terrain.weightMapSize+i,a=this._terrain.getWeight(n,s);t[4*e+0]=Math.floor(255*a.x),t[4*e+1]=Math.floor(255*a.y),t[4*e+2]=Math.floor(255*a.z),t[4*e+3]=Math.floor(255*a.w),e+=1}this._weightMap.uploadData(t)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)},e._updateLightmap=function(t){this._lightmapInfo=t,this._invalidMaterial()},n(t,[{key:"layers",get:function(){return this._info.layers}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new _(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new _(0,0,0,0)}}]),t}());t("Terrain",(xt=r("cc.Terrain"),It=w(),Et=l(q),Rt=l(F),Nt=m(),Tt=l(ne),Lt=l(ae),Pt=l(oe),Bt=l(f),Ot=l(f),Ut=l(f),Ht=l(q),Dt=m(),Vt=l(F),Ft=m(),Xt=l(re),xt(Wt=It(Wt=g(Wt=X((te=function(t){function r(){var e;e=t.call(this)||this,y(e,"__asset",Gt,S(e)),y(e,"_effectAsset",Yt,S(e)),y(e,"_layers",Kt,S(e)),y(e,"_blockInfos",qt,S(e)),y(e,"_lightmapInfos",Jt,S(e)),y(e,"_receiveShadow",Zt,S(e)),y(e,"_useNormalmap",Qt,S(e)),y(e,"_usePBR",$t,S(e)),e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var i=0;i<tt;++i)e._layers.push(null);return e}a(r,t);var s=r.prototype;return s.build=function(t){return this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildImp()},s.rebuild=function(t){for(var e=[],i=0;i<t.blockCount[0]*t.blockCount[1];++i)e.push(new ae);for(var r=Math.min(this._blockCount[0],t.blockCount[0]),n=Math.min(this._blockCount[1],t.blockCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a){var o=s*t.blockCount[0]+a,l=s*this.blockCount[0]+a;e[o]=this._blockInfos[l]}this._blockInfos=e;for(var h,u=p(this._blocks);!(h=u()).done;)h.value.destroy();this._blocks=[],this._rebuildHeights(t),this._rebuildWeights(t),this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildNormals();for(var _=0;_<this._blockCount[1];++_)for(var c=0;c<this._blockCount[0];++c)this._blocks.push(new le(this,c,_));for(var f,g=p(this._blocks);!(f=g()).done;)f.value.build()},s.importHeightField=function(t,e){for(var i=0,r=0;r<this.vertexCount[1];++r)for(var n=0;n<this.vertexCount[0];++n){var s=n/this.tileCount[0],a=r/this.tileCount[1],o=t.getAt(s*t.w,a*t.h)*e;this._heights[i++]=o}this._buildNormals();for(var l,h=p(this._blocks);!(l=h()).done;)l.value._updateHeight()},s.exportHeightField=function(t,e){for(var i=0,r=0;r<t.h;++r)for(var n=0;n<t.w;++n){var s=n/(t.w-1),a=r/(t.h-1),o=s*this.size.width,l=a*this.size.height,h=this.getHeightAt(o,l);null!=h&&(t.data[i++]=h*e)}},s.exportAsset=function(){var t=new q;t.tileSize=this.tileSize,t.blockCount=this.blockCount,t.lightMapSize=this.lightMapSize,t.weightMapSize=this.weightMapSize,t.heights=this.heights,t.weights=this.weights,t.layerBuffer=new Array(4*this._blocks.length);for(var e=0;e<this._blocks.length;++e)t.layerBuffer[4*e+0]=this._blocks[e].layers[0],t.layerBuffer[4*e+1]=this._blocks[e].layers[1],t.layerBuffer[4*e+2]=this._blocks[e].layers[2],t.layerBuffer[4*e+3]=this._blocks[e].layers[3];for(var i=0;i<this._layers.length;++i){var r=this._layers[i];if(r&&r.detailMap&&d(r.detailMap)){var n=new et;n.slot=i,n.tileSize=r.tileSize,n.detailMap=r.detailMap._uuid,t.layerInfos.push(n)}}return t},s.getEffectAsset=function(){return null===this._effectAsset?o.EffectAsset.get("terrain"):this._effectAsset},s.onLoad=function(){for(var t=o.director.root.device,e=new Uint16Array(Y*Y*6),i=0,r=0;r<Y;++r)for(var n=0;n<Y;++n){var s=r*G+n,a=r*G+n+1,l=(r+1)*G+n,h=(r+1)*G+n+1;e[i++]=s,e[i++]=l,e[i++]=a,e[i++]=a,e[i++]=l,e[i++]=h}this._sharedIndexBuffer=t.createBuffer(new I(E.INDEX|E.TRANSFER_DST,R.HOST|R.DEVICE,Uint16Array.BYTES_PER_ELEMENT*Y*Y*6,Uint16Array.BYTES_PER_ELEMENT)),this._sharedIndexBuffer.update(e)},s.onEnable=function(){0===this._blocks.length&&this._buildImp()},s.onDisable=function(){for(var t,e=p(this._blocks);!(t=e()).done;)t.value.destroy();this._blocks=[]},s.onDestroy=function(){for(var t,e=p(this._blocks);!(t=e()).done;)t.value.destroy();this._blocks=[];for(var i=0;i<this._layers.length;++i)this._layers[i]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()},s.onRestore=function(){this.onDisable(),this.onLoad(),this._buildImp(!0)},s.update=function(){for(var t,e=p(this._blocks);!(t=e()).done;)t.value.update()},s.addLayer=function(t){for(var e=0;e<this._layers.length;++e){var i;if(null===this._layers[e]||this._layers[e]&&null===(null===(i=this._layers[e])||void 0===i?void 0:i.detailMap))return this._layers[e]=t,e}return-1},s.setLayer=function(t,e){this._layers[t]=e},s.removeLayer=function(t){this._layers[t]=null},s.getLayer=function(t){return-1===t?null:this._layers[t]},s.getPosition=function(t,e){var r=t*this._tileSize,n=e*this._tileSize,s=this.getHeight(t,e);return new i(r,s,n)},s.getHeightField=function(){return this._heights},s.setHeight=function(t,i,r){r=e(r,Z,J),this._heights[i*this.vertexCount[0]+t]=Q+r/$},s.getHeight=function(t,e){return(this._heights[e*this.vertexCount[0]+t]-Q)*$},s.getHeightClamp=function(t,i){return t=e(t,0,this.vertexCount[0]-1),i=e(i,0,this.vertexCount[1]-1),this.getHeight(t,i)},s.getHeightAt=function(t,i){var r=t/this.tileSize,n=i/this.tileSize,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,u=n-a;if(s<0||s>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;s=e(s,0,this.vertexCount[0]-1),a=e(a,0,this.vertexCount[1]-1),o=e(o,0,this.vertexCount[0]-1),l=e(l,0,this.vertexCount[1]-1);var _=this.getHeight(s,a),c=this.getHeight(o,a),f=this.getHeight(s,l),g=this.getHeight(o,l),p=.5*(c+f);return h+u<=1?g=p+(p-_):_=p+(p-g),(_*(1-h)+c*h)*(1-u)+(f*(1-h)+g*h)*u},s._setNormal=function(t,e,i){var r=e*this.vertexCount[0]+t;this._normals[3*r+0]=i.x,this._normals[3*r+1]=i.y,this._normals[3*r+2]=i.z},s.getNormal=function(t,e){var r=e*this.vertexCount[0]+t,n=new i;return n.x=this._normals[3*r+0],n.y=this._normals[3*r+1],n.z=this._normals[3*r+2],n},s.getNormalAt=function(t,r){var n=t/this.tileSize,s=r/this.tileSize,a=Math.floor(n),o=Math.floor(s),l=a+1,h=o+1,u=n-a,_=s-o;if(a<0||a>this.vertexCount[0]-1||o<0||o>this.vertexCount[1]-1)return null;a=e(a,0,this.vertexCount[0]-1),o=e(o,0,this.vertexCount[1]-1),l=e(l,0,this.vertexCount[0]-1),h=e(h,0,this.vertexCount[1]-1);var c=this.getNormal(a,o),f=this.getNormal(l,o),g=this.getNormal(a,h),p=this.getNormal(l,h),d=new i;i.add(d,f,g).multiplyScalar(.5),u+_<=1?(p.set(d),p.subtract(c),p.add(d)):(c.set(d),c.subtract(p),c.add(d));var b=new i,y=new i,M=new i;return i.lerp(b,c,f,u),i.lerp(y,g,p,u),i.lerp(M,b,y,_),M},s.setWeight=function(t,e,i){var r=e*this._weightMapSize*this._blockCount[0]+t;this._weights[4*r+0]=255*i.x,this._weights[4*r+1]=255*i.y,this._weights[4*r+2]=255*i.z,this._weights[4*r+3]=255*i.w},s.getWeight=function(t,e){var i=e*this._weightMapSize*this._blockCount[0]+t,r=new _;return r.x=this._weights[4*i+0]/255,r.y=this._weights[4*i+1]/255,r.z=this._weights[4*i+2]/255,r.w=this._weights[4*i+3]/255,r},s.getWeightAt=function(t,i){var r=t/this.tileSize,n=i/this.tileSize,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,u=n-a;if(s<0||s>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;s=e(s,0,this.vertexCount[0]-1),a=e(a,0,this.vertexCount[1]-1),o=e(o,0,this.vertexCount[0]-1),l=e(l,0,this.vertexCount[1]-1);var c=this.getWeight(s,a),f=this.getWeight(o,a),g=this.getWeight(s,l),p=this.getWeight(o,l),d=new _;_.add(d,f,g).multiplyScalar(.5),h+u<=1?(p=new _,_.subtract(p,d,c).add(d)):(c=new _,_.subtract(c,d,p).add(d));var b=new _,y=new _,M=new _;return _.lerp(b,c,f,h),_.lerp(y,g,p,h),_.lerp(M,b,y,u),M},s.getBlockInfo=function(t,e){return this._blockInfos[e*this._blockCount[0]+t]},s.getBlock=function(t,e){return this._blocks[e*this._blockCount[0]+t]},s.getBlocks=function(){return this._blocks},s.rayCheck=function(t,e,r,n){void 0===n&&(n=!0);var s=t;n&&i.subtract(s,t,this.node.getWorldPosition());var a=new i;a.set(e),a.multiplyScalar(r);var o=null;if(e.equals(new i(0,1,0))){var l=this.getHeightAt(s.x,s.z);null!=l&&s.y<=l&&(o=new i(s.x,l,s.z))}else if(e.equals(new i(0,-1,0))){var h=this.getHeightAt(s.x,s.z);null!=h&&s.y>=h&&(o=new i(s.x,h,s.z))}else{for(var u=0;u++<2e3;){var _=this.getHeightAt(s.x,s.z);if(null!=_&&s.y<=_)break;s.add(e)}for(;u++<2e3;){var c=this.getHeightAt(s.x,s.z);if(null!=c&&s.y<=c){o=new i(s.x,c,s.z);break}s.add(a)}}return o},s._getSharedIndexBuffer=function(){return this._sharedIndexBuffer},s._resetLightmap=function(t){if(this._lightmapInfos.length=0,t)for(var e=0;e<this._blockCount[0]*this._blockCount[1];++e)this._lightmapInfos.push(new oe)},s._updateLightmap=function(t,e,i,r,n,s){this._lightmapInfos[t].texture=e,this._lightmapInfos[t].UOff=i,this._lightmapInfos[t].VOff=r,this._lightmapInfos[t].UScale=n,this._lightmapInfos[t].VScale=s,this._blocks[t]._updateLightmap(this._lightmapInfos[t])},s._getLightmapInfo=function(t,e){var i=e*this._blockCount[0]+t;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null},s._calcNormal=function(t,e){var r,n,s=1,a=this.getPosition(t,e);t<this.vertexCount[0]-1?r=this.getPosition(t+1,e):(s*=-1,r=this.getPosition(t-1,e)),e<this.vertexCount[1]-1?n=this.getPosition(t,e+1):(s*=-1,n=this.getPosition(t,e-1)),r.subtract(a),n.subtract(a);var o=new i;return o.set(n),o.cross(r),o.multiplyScalar(s),o.normalize(),o},s._buildNormals=function(){for(var t=0,e=0;e<this.vertexCount[1];++e)for(var i=0;i<this.vertexCount[0];++i){var r=this._calcNormal(i,e);this._normals[3*t+0]=r.x,this._normals[3*t+1]=r.y,this._normals[3*t+2]=r.z,t+=1}},s._buildImp=function(t){var e=this;if(void 0===t&&(t=!1),this.valid)return!0;var i=this.__asset;if(!t&&null!==i){this._tileSize=i.tileSize,this._blockCount=i.blockCount,this._weightMapSize=i.weightMapSize,this._lightMapSize=i.lightMapSize,this._heights=i.heights,this._weights=i.weights;for(var r=0;r<this._layers.length;++r)this._layers[r]=null;for(var n,s=function(){var t=n.value,i=new ne;i.tileSize=t.tileSize,o.assetManager.loadAny(t.detailMap,(function(t,e){i.detailMap=e})),""!==t.normalMap&&o.AssetLibrary.loadAny(t.normalMap,(function(t,e){i.normalMap=e})),i.roughness=t.roughness,i.metallic=t.metallic,e._layers[t.slot]=i},a=p(i.layerInfos);!(n=a()).done;)s()}if(0===this._blockCount[0]||0===this._blockCount[1])return!1;var l=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==l){this._heights=new Uint16Array(l),this._normals=new Array(3*l);for(var h=0;h<l;++h)this._heights[h]=Q,this._normals[3*h+0]=0,this._normals[3*h+1]=1,this._normals[3*h+2]=0}else this._normals=new Array(3*l),this._buildNormals();var u=this._weightMapSize*this._blockCount[0],_=this._weightMapSize*this._blockCount[1];if(this._weights.length!==u*_*4){this._weights=new Uint8Array(u*_*4);for(var c=0;c<u*_;++c)this._weights[4*c+0]=255,this._weights[4*c+1]=0,this._weights[4*c+2]=0,this._weights[4*c+3]=0}if(this._blockInfos.length!==this._blockCount[0]*this._blockCount[1]){this._blockInfos=[];for(var f=0;f<this._blockCount[1];++f)for(var g=0;g<this._blockCount[0];++g){var d=new ae;null!=this._asset&&(d.layers[0]=this._asset.getLayer(g,f,0),d.layers[1]=this._asset.getLayer(g,f,1),d.layers[1]===d.layers[0]&&(d.layers[1]=-1),d.layers[2]=this._asset.getLayer(g,f,2),d.layers[2]===d.layers[0]&&(d.layers[2]=-1),d.layers[3]=this._asset.getLayer(g,f,3),d.layers[3]===d.layers[0]&&(d.layers[3]=-1)),this._blockInfos.push(d)}}for(var b=0;b<this._blockCount[1];++b)for(var y=0;y<this._blockCount[0];++y)this._blocks.push(new le(this,y,b));for(var M,v=p(this._blocks);!(M=v()).done;)M.value.build()},s._rebuildHeights=function(t){if(this.vertexCount[0]===t.vertexCount[0]&&this.vertexCount[1]===t.vertexCount[1])return!1;for(var e=new Uint16Array(t.vertexCount[0]*t.vertexCount[1]),i=0;i<e.length;++i)e[i]=Q;for(var r=Math.min(this.vertexCount[0],t.vertexCount[0]),n=Math.min(this.vertexCount[1],t.vertexCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a){var o=s*t.vertexCount[0]+a,l=s*this.vertexCount[0]+a;e[o]=this._heights[l]}return this._heights=e,!0},s._rebuildWeights=function(t){var e=this,i=this._weightMapSize,r=this._weightMapSize*this._blockCount[0],n=this._weightMapSize*this._blockCount[1],s=t.weightMapSize*t.blockCount[0],a=t.weightMapSize*t.blockCount[1];if(s===r&&a===n)return!1;for(var o=new Uint8Array(s*a*4),l=0;l<s*a;++l)o[4*l+0]=255,o[4*l+1]=0,o[4*l+2]=0,o[4*l+3]=0;for(var h=Math.min(t.blockCount[0],this._blockCount[0]),u=Math.min(t.blockCount[1],this._blockCount[1]),c=function(t,e,i){var n=e*r+t,s=new _;return s.x=i[4*n+0]/255,s.y=i[4*n+1]/255,s.z=i[4*n+2]/255,s.w=i[4*n+3]/255,s},f=function(t,i,r,n){var s=Math.floor(t),a=Math.floor(i),o=s+1,l=a+1,h=t-s,u=i-a,f=c(s+r,a+n,e._weights),g=c(o+r,a+n,e._weights),p=c(s+r,l+n,e._weights),d=c(o+r,l+n,e._weights),b=new _;_.add(b,g,p).multiplyScalar(.5),h+u<=1?(d.set(b),d.subtract(f),d.add(b)):(f.set(b),f.subtract(d),f.add(b));var y=new _,M=new _,v=new _;return _.lerp(y,f,g,h),_.lerp(M,p,d,h),_.lerp(v,y,M,u),v},g=0;g<u;++g)for(var p=0;p<h;++p)for(var d=p*i,b=g*i,y=0;y<t.weightMapSize;++y)for(var M=0;M<t.weightMapSize;++M){var v=void 0;v=t.weightMapSize===i?c(M+d,y+b,this._weights):f(M/(t.weightMapSize-1)*(i-1),y/(t.weightMapSize-1)*(i-1),d,b,this._weights);var w=p*t.weightMapSize+M,m=(g*t.weightMapSize+y)*s+w;o[4*m+0]=255*v.x,o[4*m+1]=255*v.y,o[4*m+2]=255*v.z,o[4*m+3]=255*v.w}return this._weights=o,!0},n(r,[{key:"_asset",set:function(t){if(this.__asset!==t&&(this.__asset=t,null!=this.__asset&&this.valid)){for(var e,i=p(this._blocks);!(e=i()).done;)e.value.destroy();this._blocks=[],this._blockInfos=[],this._buildImp()}},get:function(){return this.__asset}},{key:"effectAsset",set:function(t){if(this._effectAsset!==t){this._effectAsset=t;for(var e,i=p(this._blocks);!(e=i()).done;)e.value._invalidMaterial()}},get:function(){return this._effectAsset}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"useNormalMap",get:function(){return this._useNormalmap},set:function(t){this._useNormalmap=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"usePBR",get:function(){return this._usePBR},set:function(t){this._usePBR=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"size",get:function(){var t=new M(0,0);return t.width=this.blockCount[0]*Y*this.tileSize,t.height=this.blockCount[1]*Y*this.tileSize,t}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*Y,this.blockCount[1]*Y]}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var t=new re;return t.tileSize=this.tileSize,t.blockCount[0]=this.blockCount[0],t.blockCount[1]=this.blockCount[1],t.weightMapSize=this.weightMapSize,t.lightMapSize=this.lightMapSize,t}}]),r}(z),Gt=s((jt=te).prototype,"__asset",[Et,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yt=s(jt.prototype,"_effectAsset",[Rt,v,k,Nt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kt=s(jt.prototype,"_layers",[Tt,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qt=s(jt.prototype,"_blockInfos",[Lt,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jt=s(jt.prototype,"_lightmapInfos",[Pt,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zt=s(jt.prototype,"_receiveShadow",[Bt,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qt=s(jt.prototype,"_useNormalmap",[Ot,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$t=s(jt.prototype,"_usePBR",[Ut,v,k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),s(jt.prototype,"_asset",[Ht,Dt],Object.getOwnPropertyDescriptor(jt.prototype,"_asset"),jt.prototype),s(jt.prototype,"effectAsset",[Vt,Ft],Object.getOwnPropertyDescriptor(jt.prototype,"effectAsset"),jt.prototype),s(jt.prototype,"receiveShadow",[b],Object.getOwnPropertyDescriptor(jt.prototype,"receiveShadow"),jt.prototype),s(jt.prototype,"useNormalMap",[b],Object.getOwnPropertyDescriptor(jt.prototype,"useNormalMap"),jt.prototype),s(jt.prototype,"usePBR",[b],Object.getOwnPropertyDescriptor(jt.prototype,"usePBR"),jt.prototype),s(jt.prototype,"info",[Xt],Object.getOwnPropertyDescriptor(jt.prototype,"info"),jt.prototype),Wt=jt))||Wt)||Wt)||Wt)||Wt))}}}));
